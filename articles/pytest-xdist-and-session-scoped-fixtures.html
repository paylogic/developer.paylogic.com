<!DOCTYPE html>
<html lang="en">
    <head>
            <title>pytest-xdist and session-scoped fixtures by Anatoly Bubenkov - Paylogic Developers</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">

                <link href="https://developer.paylogic.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Paylogic Developers Full Atom Feed">




                <link href="https://developer.paylogic.com/feeds/testing.atom.xml" type="application/atom+xml" rel="alternate" title="Paylogic Developers Categories Atom Feed">




            <link rel="shortcut icon" href="../images/favicon.ico">

            <link rel="stylesheet" type="text/css" href="../theme/css/uikit.min.css">
            <link rel="stylesheet" type="text/css" href="../theme/css/uikit.addons.min.css">
            <link rel="stylesheet" type="text/css" href="../theme/css/style.css">
    </head>

    <body>

        <nav class="uk-navbar" data-uk-sticky>
            <div class="uk-container uk-container-center">
                <a href="/" class="uk-navbar-brand"><img alt="Paylogic" src="../images/paylogic.png" /></a>
                <div class="uk-navbar-content"><a href="/" class="pl-text-light">Developers</a></div>
                <ul class="uk-navbar-nav uk-float-right uk-hidden-small">
                        <li><a href="/pages/integration.html">Integration</a></li>
                        <li><a href="/archives.html">Articles</a></li>
                        <li><a href="/authors.html">Authors</a></li>
                    <li class="uk-parent" data-uk-dropdown>
                        <a href="#">Categories<i class="uk-icon-angle-down uk-margin-small-left"></i></a>
                        <div class="uk-dropdown uk-dropdown-flip uk-dropdown-navbar">
                            <ul class="uk-nav uk-nav-navbar">
                                        <li><a href="../category/agile.html">Agile</a></li>
                                        <li><a href="../category/devops.html">DevOps</a></li>
                                        <li><a href="../category/general.html">General</a></li>
                                        <li><a href="../category/integration.html">Integration</a></li>
                                        <li><a href="../category/open-source.html">Open source</a></li>
                                        <li class="uk-active"><a href="../category/testing.html">Testing</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
                <a href="#offcanvas-nav" class="uk-navbar-toggle uk-visible-small uk-float-right" data-uk-offcanvas></a>
            </div>
        </nav>

        <div id="offcanvas-nav" class="uk-offcanvas">
            <div class="uk-offcanvas-bar">
                <ul class="uk-nav uk-nav-offcanvas uk-nav-parent-icon" data-uk-nav="{multiple:true}">
                        <li><a href="/pages/integration.html">Integration</a></li>
                        <li><a href="/archives.html">Articles</a></li>
                        <li><a href="/authors.html">Authors</a></li>
                    <li class="uk-parent">
                        <a href="#">Categories</a>
                        <ul class="uk-nav-sub">
                                    <li><a href="../category/agile.html">Agile</a></li>
                                    <li><a href="../category/devops.html">DevOps</a></li>
                                    <li><a href="../category/general.html">General</a></li>
                                    <li><a href="../category/integration.html">Integration</a></li>
                                    <li><a href="../category/open-source.html">Open source</a></li>
                                    <li class="uk-active"><a href="../category/testing.html">Testing</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

        <main class="pl-content">
<section class="pl-section">
    <div class="uk-container uk-container-center">
        <div class="uk-grid" data-uk-grid-margin>
            <div class="uk-width-medium-1-4 uk-hidden-small">
                <div class="toc uk-text-small" data-uk-sticky="{top:76}" data-uk-scrollspy-nav>
                <div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#back-to-the-example-where-the-problem-starts" id="id3">Back to the example, where the problem starts</a></li>
<li><a class="reference internal" href="#pytest-xdist-internals" id="id4">pytest-xdist internals</a></li>
<li><a class="reference internal" href="#how-to-avoid-multiple-sessions-on-single-node" id="id5">How to avoid multiple sessions on single node</a></li>
<li><a class="reference internal" href="#conclusion" id="id6">Conclusion</a></li>
</ul>
</div>
                </div>
            </div>
            <div class="uk-width-medium-3-4">
                <article class="uk-article">
                    <table class="uk-table uk-table-middle pl-table-article-meta">
                        <tbody>
                            <tr>
                                <td>
                                    <div class="uk-thumbnail uk-margin-right">
                                        <img src="http://www.gravatar.com/avatar/4e2517ef01ac77a6a0b251336a6ce224" alt="Anatoly Bubenkov" />
                                    </div>
                                </td>
                                <td>
                                    <div class="uk-article-meta">
                                        Written by
                                            <a class="url fn" href="../author/anatoly-bubenkov.html">Anatoly Bubenkov</a>
                                        on Wed 28 May 2014<br />Posted in <a href="../category/testing.html">Testing</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <h1 class="uk-article-title">pytest-xdist and session-scoped fixtures</h1>
                    <hr class="uk-article-divider">
                    <div class="pl-article-content">
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a></h2>
<p>In the earlier <a class="reference external" href="test-p14n">article on Test parallelization</a> we unveiled how we <tt class="docutils literal">parallelize</tt> our tests.
There we gave a few examples of services we run for the tests. However, due to implementation details of
<a class="reference external" href="https://pytest.org">pytest</a> and <a class="reference external" href="https://pytest.org/latest/xdist.html">pytest-xdist</a>, it is not possible
to implement service starting and stopping efficiently out of the box. That's why we developed our own solution,
described in this article.</p>
</div>
<div class="section" id="back-to-the-example-where-the-problem-starts">
<h2><a class="toc-backref" href="#id3">Back to the example, where the problem starts</a></h2>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">execnet</span>

<span class="k">def</span> <span class="nf">app_worker</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">database_connection</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="sd">"""Start web application.</span>

<span class="sd">    :param channel: execnet channel to talk to the master process.</span>
<span class="sd">    :param str database_connection: the database connection string.</span>
<span class="sd">    :param port: the port number that will be used by runserver.</span>

<span class="sd">    """</span>
    <span class="c1"># monkey patch the database connection</span>
    <span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">database</span>
    <span class="n">database</span><span class="o">.</span><span class="n">database_connection</span> <span class="o">=</span> <span class="n">database_connection</span>

    <span class="kn">import</span> <span class="nn">tornado.httpserver</span>
    <span class="kn">import</span> <span class="nn">tornado.ioloop</span>
    <span class="kn">import</span> <span class="nn">tornado.web</span>
    <span class="kn">import</span> <span class="nn">tornado.wsgi</span>

    <span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIContainer</span><span class="p">(</span>
        <span class="n">app_wsgi_handler</span><span class="p">)</span>
    <span class="n">tornado_app</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">"/media/(.*)"</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">StaticFileHandler</span><span class="p">,</span> <span class="p">{</span><span class="s2">"path"</span><span class="p">:</span> <span class="n">media_path</span><span class="p">}),</span>
        <span class="p">(</span><span class="s1">'.*'</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">FallbackHandler</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="n">wsgi_app</span><span class="p">)),</span>
    <span class="p">])</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span><span class="n">tornado_app</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'started app on port: {0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">'session'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">database_connection</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">"""Start application in a separate process.</span>

<span class="sd">    :param port: a random port the application should listen to.</span>

<span class="sd">    """</span>
    <span class="c1"># create execnet gateway</span>
    <span class="n">gw</span> <span class="o">=</span> <span class="n">execnet</span><span class="o">.</span><span class="n">makegateway</span><span class="p">()</span>

    <span class="c1"># set the same python system path on remote python as on current one</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">gw</span><span class="o">.</span><span class="n">remote_exec</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">"import sys"</span><span class="p">,</span>
            <span class="s2">"sys.path = {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">))</span><span class="o">.</span><span class="n">waitclose</span><span class="p">()</span>

    <span class="c1"># create channel running worker function</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="n">remote_exec</span><span class="p">(</span>
        <span class="n">app_worker</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
        <span class="n">database_connection</span><span class="o">=</span><span class="n">database_connection</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">gw</span><span class="o">.</span><span class="n">exit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gw</span>
</pre></div>
<p>What is extremely important here is that we instantiate things like applications and services
only once per test run, because it takes a lot of time to start / stop applications and/or services,
to create databases, etc.</p>
<p>According to <a class="reference external" href="https://pytest.org/latest/fixture.html">pytest fixtures</a>, our application will be instantiated
on demand and should live during the whole test session time. Which is fine, as long as you do
not <tt class="docutils literal">parallelize</tt> tests, and therefore do not use <a class="reference external" href="https://pytest.org/latest/xdist.html">pytest-xdist</a>.</p>
<p>But when you do use it, it's <strong>not guaranteed</strong> that test nodes will have only one test session!</p>
</div>
<div class="section" id="pytest-xdist-internals">
<h2><a class="toc-backref" href="#id4">pytest-xdist internals</a></h2>
<p>To simplify things, let's concentrate on the <tt class="docutils literal">stages</tt> that <tt class="docutils literal"><span class="pre">pytest-xdist</span></tt> uses to run tests in a distributed way:</p>
<ul>
<li><p class="first">Collect all nodes checking the connection</p>
</li>
<li><p class="first">Rsync files needed</p>
</li>
<li><p class="first">Collect all tests on every node</p>
</li>
<li><p class="first">Start 'initial distribution' test sessions over nodes using the number of tests calculated by the following formula:</p>
<blockquote>
<div class="formula">
<i>ntests</i> = <i>Ntests</i> ⁄ (<i>Knodes</i>*4)
</div>
<dl class="docutils">
<dt>where:</dt>
<dd><ul class="first last simple">
<li>ntests - number of tests to run for test node session</li>
<li>Ntests - total number of tests</li>
<li>Knodes - number of test nodes</li>
</ul>
</dd>
</dl>
</blockquote>
</li>
<li><p class="first">Start more test sessions for nodes which are done with initial test sessions using the same formula</p>
</li>
</ul>
<p>We see here that the more tests you have for the same amount of nodes, the more test sessions will be started!</p>
<p>In the below diagram we can see how it works in a more visual way:</p>
<img alt="pytest-xdist in action" class="align-center" src="../images/pytest-xdist-in-action.png" style="width: 75%;"/>
</div>
<div class="section" id="how-to-avoid-multiple-sessions-on-single-node">
<h2><a class="toc-backref" href="#id5">How to avoid multiple sessions on single node</a></h2>
<p>So we know that it's possible to get not one but several sessions during the test run on a single node.
How can we avoid that? Fortunately, even though we have multiple sessions per node, it's still the same python process,
so we can cache objects on module level. In this way we <em>invent</em> a new fixture scope - <tt class="docutils literal">test run</tt>.
For fixtures within this scope, the fixture and its finalizer will be called only once per whole test run on a given test node.
Here is the implementation of the utility decorator that we use:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">decorator</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="n">marker</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_memoize</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">"""Memoization helper to cache function's return value as an attribute of this function."""</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">'_cache'</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="n">marker</span><span class="p">:</span>
        <span class="n">func</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">_cache</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cache</span>


<span class="k">def</span> <span class="nf">memoize</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">"""Decorator which caches the return value of the function."""</span>
    <span class="k">return</span> <span class="n">decorator</span><span class="o">.</span><span class="n">decorator</span><span class="p">(</span><span class="n">_memoize</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
<p>As you can see it's a pretty straightforward application of the <a class="reference external" href="http://en.wikipedia.org/wiki/Memoization">memoization
technique</a> using function object as
a cache storage based on the <a class="reference external" href="https://pypi.python.org/pypi/decorator/3.4.0">decorator</a> package.
The <tt class="docutils literal">decorator</tt> package is needed to preserve the function
prototype which is important for the <tt class="docutils literal">pytest fixture dependency injection mechanism</tt>.</p>
<p>So now our application fixture looks like this:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">atexit</span>

<span class="kn">import</span> <span class="nn">execnet</span>

<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">'session'</span><span class="p">)</span>
<span class="nd">@memoize</span>
<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">database_connection</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">"""Start application in a separate process.</span>

<span class="sd">    :param port: a random port the application should listen to.</span>

<span class="sd">    """</span>
    <span class="c1"># create execnet gateway</span>
    <span class="n">gw</span> <span class="o">=</span> <span class="n">execnet</span><span class="o">.</span><span class="n">makegateway</span><span class="p">()</span>

    <span class="c1"># set the same python system path on remote python as on current one</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">gw</span><span class="o">.</span><span class="n">remote_exec</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">"import sys"</span><span class="p">,</span>
            <span class="s2">"sys.path = {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">))</span><span class="o">.</span><span class="n">waitclose</span><span class="p">()</span>

    <span class="c1"># create channel running worker function</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="n">remote_exec</span><span class="p">(</span>
        <span class="n">app_worker</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
        <span class="n">database_connection</span><span class="o">=</span><span class="n">database_connection</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">gw</span><span class="o">.</span><span class="n">exit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gw</span>
</pre></div>
<p>By using the <tt class="docutils literal">memoize</tt> decorator we avoid calling the <tt class="docutils literal">application</tt> function multiple times during the test run, even if
there will be multiple sessions involved on a single test node.
The result of the first call of the <tt class="docutils literal">application</tt> function will be cached as an attribute on the application function.
Subsequent calls will just return the cached value.
Note that instead of <tt class="docutils literal">request.addfinalizer</tt> we use <tt class="docutils literal">atexit.register</tt>. This is because memoization has it's downside - we cannot use
pytest's normal fixture finalizers simply because there's no scope higher than <tt class="docutils literal">session</tt> at the moment.</p>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id6">Conclusion</a></h2>
<p>We identified a few advantages of using the approach discussed in the previous sections.
This approach allowed us to considerably reduce our test execution time.
It also improved the test stability, because the OS performs better as it doesn't need to spawn and kill lots
of processes. We hope that you will find our approach useful, especially if you use <tt class="docutils literal">pytest</tt> and <tt class="docutils literal"><span class="pre">pytest-xdist</span></tt>,
as you will probably run into the same issues as we did.</p>
</div>
</div>
                        <hr class="uk-article-divider">
                        <div class="comments">
                            <h2>Comments</h2>
                            <div id="disqus_thread"></div>
                            <script type="text/javascript">
                                var disqus_identifier = "articles/pytest-xdist-and-session-scoped-fixtures.html";
                                (function() {
                                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                                    dsq.src = 'http://paylogicdevportal.disqus.com/embed.js';
                                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                                })();
                            </script>
                        </div>
                </article>
            </div>
        </div>
    </div>
</section>
        </main>

        <footer class="pl-footer">
            <div>
                <div class="uk-container uk-container-center uk-text-center uk-text-small">
                    <ul class="uk-subnav uk-subnav-line">
                        <li><a href="../pages/about.html">About</a></li>
                        <li><a href="https://shopping-api-docs.sandbox.paylogic.com/" target="_blank">API</a></li>
                        <li><a href="https://github.com/paylogic" target="_blank">GitHub</a></li>
                        <li><a href="http://www.pygrunn.org/" target="_blank">PyGrunn</a></li>
                    </ul>
                    Copyright (c) 2017 <a href="http://www.paylogic.com" target="_blank">Paylogic</a>,
                    built using the awesome <a href="http://getpelican.com" target="_blank">Pelican</a> static site generator.<br>
                    This work is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/" target="_blank">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
                </div>
            </div>
        </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="../theme/js/uikit.min.js"></script>
        <script src="../theme/js/sticky.min.js"></script>
        <script src="../theme/js/cover.min.js"></script>
        <script src="../theme/js/application.js"></script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-13304573-19', 'paylogic.com');
            ga('send', 'pageview');
        </script>

    </body>
</html>