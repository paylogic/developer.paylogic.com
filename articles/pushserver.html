<!DOCTYPE html>
<html lang="en">
    <head>
            <title>pushserver by Anatoly Bubenkov - Paylogic Developers</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">

                <link href="http://developer.paylogic.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Paylogic Developers Full Atom Feed">




                <link href="http://developer.paylogic.com/feeds/open-source.atom.xml" type="application/atom+xml" rel="alternate" title="Paylogic Developers Categories Atom Feed">




            <link rel="shortcut icon" href="http://developer.paylogic.com/images/favicon.ico">

            <link rel="stylesheet" type="text/css" href="http://developer.paylogic.com/theme/css/uikit.min.css">
            <link rel="stylesheet" type="text/css" href="http://developer.paylogic.com/theme/css/uikit.addons.min.css">
            <link rel="stylesheet" type="text/css" href="http://developer.paylogic.com/theme/css/style.css">
    </head>

    <body>

        <nav class="uk-navbar" data-uk-sticky>
            <div class="uk-container uk-container-center">
                <a href="/" class="uk-navbar-brand"><img alt="Paylogic" src="http://developer.paylogic.com/images/paylogic.png" /></a>
                <div class="uk-navbar-content"><a href="/" class="pl-text-light">Developers</a></div>
                <ul class="uk-navbar-nav uk-float-right uk-hidden-small">
                        <li><a href="/pages/integration.html">Integration</a></li>
                        <li><a href="/archives.html">Articles</a></li>
                        <li><a href="/authors.html">Authors</a></li>
                    <li class="uk-parent" data-uk-dropdown>
                        <a href="#">Categories<i class="uk-icon-angle-down uk-margin-small-left"></i></a>
                        <div class="uk-dropdown uk-dropdown-flip uk-dropdown-navbar">
                            <ul class="uk-nav uk-nav-navbar">
                                        <li><a href="http://developer.paylogic.com/category/agile.html">Agile</a></li>
                                        <li><a href="http://developer.paylogic.com/category/devops.html">DevOps</a></li>
                                        <li><a href="http://developer.paylogic.com/category/general.html">General</a></li>
                                        <li><a href="http://developer.paylogic.com/category/integration.html">Integration</a></li>
                                        <li class="uk-active"><a href="http://developer.paylogic.com/category/open-source.html">Open source</a></li>
                                        <li><a href="http://developer.paylogic.com/category/testing.html">Testing</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
                <a href="#offcanvas-nav" class="uk-navbar-toggle uk-visible-small uk-float-right" data-uk-offcanvas></a>
            </div>
        </nav>

        <div id="offcanvas-nav" class="uk-offcanvas">
            <div class="uk-offcanvas-bar">
                <ul class="uk-nav uk-nav-offcanvas uk-nav-parent-icon" data-uk-nav="{multiple:true}">
                        <li><a href="/pages/integration.html">Integration</a></li>
                        <li><a href="/archives.html">Articles</a></li>
                        <li><a href="/authors.html">Authors</a></li>
                    <li class="uk-parent">
                        <a href="#">Categories</a>
                        <ul class="uk-nav-sub">
                                    <li><a href="http://developer.paylogic.com/category/agile.html">Agile</a></li>
                                    <li><a href="http://developer.paylogic.com/category/devops.html">DevOps</a></li>
                                    <li><a href="http://developer.paylogic.com/category/general.html">General</a></li>
                                    <li><a href="http://developer.paylogic.com/category/integration.html">Integration</a></li>
                                    <li class="uk-active"><a href="http://developer.paylogic.com/category/open-source.html">Open source</a></li>
                                    <li><a href="http://developer.paylogic.com/category/testing.html">Testing</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

        <main class="pl-content">
<section class="pl-section">
    <div class="uk-container uk-container-center">
        <div class="uk-grid" data-uk-grid-margin>
            <div class="uk-width-medium-1-4 uk-hidden-small">
                <div class="toc uk-text-small" data-uk-sticky="{top:76}" data-uk-scrollspy-nav>
                <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#user-experience" id="id2">User experience</a></li>
<li><a class="reference internal" href="#but-how-to-implement-this" id="id3">But how to implement this?</a></li>
<li><a class="reference internal" href="#use-case" id="id4">Use-case</a></li>
<li><a class="reference internal" href="#sending-events-to-a-push-server" id="id5">Sending events to a push server</a></li>
<li><a class="reference internal" href="#receiving-events-in-the-browser" id="id6">Receiving events in the browser</a></li>
<li><a class="reference internal" href="#live-demo" id="id7">Live demo</a></li>
<li><a class="reference internal" href="#future-considerations-for-paylogic" id="id8">Future considerations for Paylogic</a></li>
</ul>
</div>
                </div>
            </div>
            <div class="uk-width-medium-3-4">
                <article class="uk-article">
                    <table class="uk-table uk-table-middle pl-table-article-meta">
                        <tbody>
                            <tr>
                                <td>
                                    <div class="uk-thumbnail uk-margin-right">
                                        <i class="uk-icon-user uk-icon-large"></i>
                                    </div>
                                </td>
                                <td>
                                    <div class="uk-article-meta">
                                        Written by
                                            <a class="url fn" href="http://developer.paylogic.com/author/anatoly-bubenkov.html">Anatoly Bubenkov</a>
                                        on Mon 09 February 2015<br />Posted in <a href="http://developer.paylogic.com/category/open-source.html">Open source</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <h1 class="uk-article-title">pushserver</h1>
                    <hr class="uk-article-divider">
                    <div class="pl-article-content">
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>Paylogic is constantly working to improve the user experience of it's ticketing platform. When buying a ticket, one of
the most important things to know is the amount of available tickets. The Paylogic Frontoffice is one of the products
Paylogic uses to allow event organizers to sell tickets for their events. It is a simple yet powerful and flexible web
application. The purchasing process is set up as a wizard with a dynamic set of steps: select tickets, order overview,
payment and so on. The availability counter shows the user how many tickets are still available for a certain event. At
the moment the Paylogic Frontoffice does not have a real-time indication of the ticket availability. The user selects
his tickets and pushes the "next" button. If all goes well the user is simply forwarded to the next step. If, however,
there are not enough tickets available to satisfy the users request, he is send back to the ticket selection step and
informed about this. This leads to a constant request-response football between the user and the backend just to figure
out the maximum number of tickets the user can buy. In comes the <a class="reference external" href="https://github.com/paylogic/pushserver">pushserver</a>
which enables the backend services to send real-time events to the web clients. This article describes the motivation
and gives a brief overview of the technology and implementation details of a <tt class="docutils literal">pushserver</tt>.</p>
</div>
<div class="section" id="user-experience">
<h2><a class="toc-backref" href="#id2">User experience</a></h2>
<p>Paylogic is constantly improving the user experience of it's' products. The Frontoffice being the most important among
them. The basic flow of the ticket sale can be simplified as the following steps:</p>
<ul class="simple">
<li>Get the list of available ticket types</li>
<li>Select the requested ticket quantities</li>
<li>Check out the basket</li>
</ul>
<p>The second step becomes difficult for the user if the number of available tickets is limited. To allow the user to make
the right choice he needs to know how many tickets are still available. The question becomes: how does the user get to
know this, and more importantly, when. The user might be pondering over the available ticket types for a few minutes. At
the same time another user might come in and take some tickets. How does the first user know that the number of
available tickets was changed?</p>
<p>This problem can be solved in several ways:</p>
<dl class="docutils">
<dt>Update the availability when the choice is made.</dt>
<dd>If after clicking the next button it turns out there are not enough tickets available, an error will be send
to the user with the updated availability counter. This is probably the simplest option to implement. However, from
the user's perspective this process is unnatural and unintuitive. The user doesn't expect that there is only 1
ticket left if the select box allowed him to select
10.</dd>
<dt>Update the availability on an interval, e.g. every 10 seconds.</dt>
<dd>This is more user-friendly but if we take a very short period to emulate real-time updates, then this can be
problematic for the server to handle. In essence it will look like DDOS attack, as during peak sales we have tens of
thousands of users using the Frontoffice all at once.</dd>
<dt>Update the availability at the time it changes.</dt>
<dd>If there's no change, why bother the client's browser with information it already knows? This also allows the
servers to not get overloaded as it is no longer the browser but the pushserver who is deciding on the amount of
traffic.</dd>
</dl>
</div>
<div class="section" id="but-how-to-implement-this">
<h2><a class="toc-backref" href="#id3">But how to implement this?</a></h2>
<p>So we need a way to send updates from the server to the client without the need for the browser to explicitly request
the new information. There's a nice <a class="reference external" href="http://stackoverflow.com/questions/11077857/what-are-long-polling-websockets-server-sent-events-sse-and-comet/12855533#12855533">answer</a>
at Stack Overflow which describes the basic options for such a scheme.</p>
<p>There are a few options available:</p>
<dl class="docutils">
<dt><a class="reference external" href="http://en.wikipedia.org/wiki/Push_technology#Long_polling">Long polling</a></dt>
<dd>Browser support is 100%. That's probably the only strong point of this technique. The problem of constantly
reconnecting and state recovery is completely in the hands of the implementation. There are no helpers provided by
any standard as there's no such thing. It really is just a normal HTTP request which takes a long time and to the
browser it's just one big document.</dd>
<dt><a class="reference external" href="http://en.wikipedia.org/wiki/WebSocket">Websockets</a></dt>
<dd><a class="reference external" href="http://caniuse.com/websockets">Browser support</a> is not 100% but is very good. Is it what's needed for our
problem? It could fit very well but it gives us much more than we need. Websockets provide a two-way communication
channel but we don't really need that for our problem. All updates are coming <tt class="docutils literal">from</tt> the server. Updates from the
client are done using normal requests (XMLHttpRequest or regular POST). Additionally websockets are not HTTP but raw
TCP, HTTP is only used for the handshake. This means it requires much more hassle from the OPIT side as they will
need to set up a raw TCP service next to the current web service.</dd>
<dt><a class="reference external" href="http://en.wikipedia.org/wiki/Server-sent_events">Server sent events (SSE)</a></dt>
<dd>Browser support is <a class="reference external" href="http://caniuse.com/eventsource">not that bad</a>, and increasing constantly. Server sent events
provide a one-way communication channel. However, this channel has some very useful features provided by the
browser:
* Automatic reconnect in case of a connection problem
* State restoration on reconnect (the browser sends the last event ID it received before the disconnect)
* A very easy javascript interface</dd>
</dl>
<p>Those options all provide the possibilities we need but they are not equal. SSE seems to be the most optimal for our use
case. As we use Python a lot, we've looked around for some existing solutions which implement SSE server-side. We've
found <a class="reference external" href="https://github.com/DazWorrall/flask-sse">flask sse</a>, which seems to be exactly what we need.</p>
<p>Flask-sse uses Redis <a class="reference external" href="http://redis.io/topics/pubsub">pubsub</a> as a backend for broadcasting the events from the server.
It uses <a class="reference external" href="http://redis.io/topics/cluster-spec">redis-cluster</a> which is currently in beta, but <a class="reference external" href="http://antirez.com/news/79">will be released soon</a> (and is actually already used in production as reported by Salvatore Sanfilippo).
Flask-sse on top of redis-cluster allows us to have a high available, scalable web service.</p>
</div>
<div class="section" id="use-case">
<h2><a class="toc-backref" href="#id4">Use-case</a></h2>
<p>A possible use-case can be drawn as follows:</p>
<img alt="pushserver use-case from the user perspective" class="align-center" src="http://developer.paylogic.com/images/pushserver/diagram-user-perspective.png"/>
<p>The actor changes some data on the backend via a normal request to the backend. All users receive the broadcasted
message from the backend via long-lasting channel for server-sent events.</p>
<p>The deployment may look like this:</p>
<img alt="pushserver use-case possible deployment schema" class="align-center" src="http://developer.paylogic.com/images/pushserver/diagram-deployment.png"/>
</div>
<div class="section" id="sending-events-to-a-push-server">
<h2><a class="toc-backref" href="#id5">Sending events to a push server</a></h2>
<pre class="literal-block">
from flask.ext.sse import send_event

send_event('myevent', {"message": "Hello!"}, channel='mychannel')
</pre>
</div>
<div class="section" id="receiving-events-in-the-browser">
<h2><a class="toc-backref" href="#id6">Receiving events in the browser</a></h2>
<p>On the client side you just need a javascipt handler function which will be called when a new message is pushed from the
server.</p>
<pre class="literal-block">
var source = new EventSource('/stream?channel=mychannel');
source.addEventListener('myevent', function (event) {
     alert(event.data);
};
</pre>
<p>Server-Sent Events are <a class="reference external" href="http://caniuse.com/#feat=eventsource">supported</a> by recent Firefox, Chrome and Safari
browsers. Internet Explorer does not yet support Server-Sent Events but there are two recommended Polyfills to support
IE and older browsers:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/remy/polyfills/blob/master/EventSource.js">EventSource.js</a></li>
<li><a class="reference external" href="https://github.com/rwldrn/jquery.eventsource">jquery.eventsource</a></li>
</ul>
<p>Mobile browsers have limited support, so test carefully whether it works for your target set of browsers.</p>
</div>
<div class="section" id="live-demo">
<h2><a class="toc-backref" href="#id7">Live demo</a></h2>
<p>Here is a small demo video of the potential of this technique: we use pushserver to update the ticket availability in
our Frontoffice application. The left and right windows are operated by different users and are completely independent.
When the ticket availability is changed by an action from the left window's operator, the right window changes instantly
without any polling involved (you can see the network bar).</p>
<p>A simple Frontoffice where you can only select the quantity of tickets:</p>
<video controls="" height="480" poster="/images/pushserver/pushserver-in-action.png" preload="none" src="/videos/pushserver-in-action.mov" width="720"></video><p>A More advanced example where you can pick a seat:</p>
<video controls="" height="480" poster="/images/pushserver/pushserver-seating-demo.png" preload="none" src="/videos/pushserver-seating-demo.mov" width="720"></video></div>
<div class="section" id="future-considerations-for-paylogic">
<h2><a class="toc-backref" href="#id8">Future considerations for Paylogic</a></h2>
<p>We are considering creating a special stream API where API users can subscribe to events and get them instantly instead
of needing to poll the state from time to time. This is especially important for things like collecting the result of
payment processing, ticket availability changes, etc.</p>
<p>For now, Server sent events are more like an experiment for us, but it's a promising technology. We're eager to hear
some feedback from developers who use our API on whether it will be useful for them to have a stream API.</p>
</div>
</div>
                        <hr class="uk-article-divider">
                        <div class="comments">
                            <h2>Comments</h2>
                            <div id="disqus_thread"></div>
                            <script type="text/javascript">
                                var disqus_identifier = "articles/pushserver.html";
                                (function() {
                                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                                    dsq.src = 'http://paylogicdevportal.disqus.com/embed.js';
                                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                                })();
                            </script>
                        </div>
                </article>
            </div>
        </div>
    </div>
</section>
        </main>

        <footer class="pl-footer">
            <div>
                <div class="uk-container uk-container-center uk-text-center uk-text-small">
                    <ul class="uk-subnav uk-subnav-line">
                        <li><a href="http://developer.paylogic.com/pages/about.html">About</a></li>
                        <li><a href="https://shopping-api-docs.sandbox.paylogic.com/" target="_blank">API</a></li>
                        <li><a href="https://github.com/paylogic" target="_blank">GitHub</a></li>
                        <li><a href="http://www.pygrunn.org/" target="_blank">PyGrunn</a></li>
                    </ul>
                    Copyright (c) 2017 <a href="http://www.paylogic.com" target="_blank">Paylogic</a>,
                    built using the awesome <a href="http://getpelican.com" target="_blank">Pelican</a> static site generator.<br>
                    This work is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/" target="_blank">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
                </div>
            </div>
        </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="http://developer.paylogic.com/theme/js/uikit.min.js"></script>
        <script src="http://developer.paylogic.com/theme/js/sticky.min.js"></script>
        <script src="http://developer.paylogic.com/theme/js/cover.min.js"></script>
        <script src="http://developer.paylogic.com/theme/js/application.js"></script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-13304573-19', 'paylogic.com');
            ga('send', 'pageview');
        </script>

    </body>
</html>