<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Paylogic Developers</title><link href="http://developer.paylogic.com/" rel="alternate"></link><link href="http://developer.paylogic.com/feeds/all.atom.xml" rel="self"></link><id>http://developer.paylogic.com/</id><updated>2015-02-09T13:01:00+01:00</updated><entry><title>pushserver</title><link href="http://developer.paylogic.com/articles/pushserver.html" rel="alternate"></link><updated>2015-02-09T13:01:00+01:00</updated><author><name>Anatoly Bubenkov</name></author><id>tag:developer.paylogic.com,2015-02-09:articles/pushserver.html</id><summary type="html">
&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id1"&gt;Introduction&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Paylogic is constantly working to improve the user experience of it's ticketing platform. When buying a ticket, one of
the most important things to know is the amount of available tickets. The Paylogic Frontoffice is one of the products
Paylogic uses to allow event organizers to sell tickets for their events. It is a simple yet powerful and flexible web
application. The purchasing process is set up as a wizard with a dynamic set of steps: select tickets, order overview,
payment and so on. The availability counter shows the user how many tickets are still available for a certain event. At
the moment the Paylogic Frontoffice does not have a real-time indication of the ticket availability. The user selects
his tickets and pushes the "next" button. If all goes well the user is simply forwarded to the next step. If, however,
there are not enough tickets available to satisfy the users request, he is send back to the ticket selection step and
informed about this. This leads to a constant request-response football between the user and the backend just to figure
out the maximum number of tickets the user can buy. In comes the &lt;a class="reference external" href="https://github.com/paylogic/pushserver"&gt;pushserver&lt;/a&gt;
which enables the backend services to send real-time events to the web clients. This article describes the motivation
and gives a brief overview of the technology and implementation details of a &lt;tt class="docutils literal"&gt;pushserver&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="user-experience"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id2"&gt;User experience&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Paylogic is constantly improving the user experience of it's' products. The Frontoffice being the most important among
them. The basic flow of the ticket sale can be simplified as the following steps:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Get the list of available ticket types&lt;/li&gt;
&lt;li&gt;Select the requested ticket quantities&lt;/li&gt;
&lt;li&gt;Check out the basket&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The second step becomes difficult for the user if the number of available tickets is limited. To allow the user to make
the right choice he needs to know how many tickets are still available. The question becomes: how does the user get to
know this, and more importantly, when. The user might be pondering over the available ticket types for a few minutes. At
the same time another user might come in and take some tickets. How does the first user know that the number of
available tickets was changed?&lt;/p&gt;
&lt;p&gt;This problem can be solved in several ways:&lt;/p&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;Update the availability when the choice is made.&lt;/dt&gt;
&lt;dd&gt;If after clicking the next button it turns out there are not enough tickets available, an error will be send
to the user with the updated availability counter. This is probably the simplest option to implement. However, from
the user's perspective this process is unnatural and unintuitive. The user doesn't expect that there is only 1
ticket left if the select box allowed him to select
10.&lt;/dd&gt;
&lt;dt&gt;Update the availability on an interval, e.g. every 10 seconds.&lt;/dt&gt;
&lt;dd&gt;This is more user-friendly but if we take a very short period to emulate real-time updates, then this can be
problematic for the server to handle. In essence it will look like DDOS attack, as during peak sales we have tens of
thousands of users using the Frontoffice all at once.&lt;/dd&gt;
&lt;dt&gt;Update the availability at the time it changes.&lt;/dt&gt;
&lt;dd&gt;If there's no change, why bother the client's browser with information it already knows? This also allows the
servers to not get overloaded as it is no longer the browser but the pushserver who is deciding on the amount of
traffic.&lt;/dd&gt;
&lt;/dl&gt;
&lt;/div&gt;
&lt;div class="section" id="but-how-to-implement-this"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;But how to implement this?&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;So we need a way to send updates from the server to the client without the need for the browser to explicitly request
the new information. There's a nice &lt;a class="reference external" href="http://stackoverflow.com/questions/11077857/what-are-long-polling-websockets-server-sent-events-sse-and-comet/12855533#12855533"&gt;answer&lt;/a&gt;
at Stack Overflow which describes the basic options for such a scheme.&lt;/p&gt;
&lt;p&gt;There are a few options available:&lt;/p&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;&lt;a class="reference external" href="http://en.wikipedia.org/wiki/Push_technology#Long_polling"&gt;Long polling&lt;/a&gt;&lt;/dt&gt;
&lt;dd&gt;Browser support is 100%. That's probably the only strong point of this technique. The problem of constantly
reconnecting and state recovery is completely in the hands of the implementation. There are no helpers provided by
any standard as there's no such thing. It really is just a normal HTTP request which takes a long time and to the
browser it's just one big document.&lt;/dd&gt;
&lt;dt&gt;&lt;a class="reference external" href="http://en.wikipedia.org/wiki/WebSocket"&gt;Websockets&lt;/a&gt;&lt;/dt&gt;
&lt;dd&gt;&lt;a class="reference external" href="http://caniuse.com/websockets"&gt;Browser support&lt;/a&gt; is not 100% but is very good. Is it what's needed for our
problem? It could fit very well but it gives us much more than we need. Websockets provide a two-way communication
channel but we don't really need that for our problem. All updates are coming &lt;tt class="docutils literal"&gt;from&lt;/tt&gt; the server. Updates from the
client are done using normal requests (XMLHttpRequest or regular POST). Additionally websockets are not HTTP but raw
TCP, HTTP is only used for the handshake. This means it requires much more hassle from the OPIT side as they will
need to set up a raw TCP service next to the current web service.&lt;/dd&gt;
&lt;dt&gt;&lt;a class="reference external" href="http://en.wikipedia.org/wiki/Server-sent_events"&gt;Server sent events (SSE)&lt;/a&gt;&lt;/dt&gt;
&lt;dd&gt;Browser support is &lt;a class="reference external" href="http://caniuse.com/eventsource"&gt;not that bad&lt;/a&gt;, and increasing constantly. Server sent events
provide a one-way communication channel. However, this channel has some very useful features provided by the
browser:
* Automatic reconnect in case of a connection problem
* State restoration on reconnect (the browser sends the last event ID it received before the disconnect)
* A very easy javascript interface&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;Those options all provide the possibilities we need but they are not equal. SSE seems to be the most optimal for our use
case. As we use Python a lot, we've looked around for some existing solutions which implement SSE server-side. We've
found &lt;a class="reference external" href="https://github.com/DazWorrall/flask-sse"&gt;flask sse&lt;/a&gt;, which seems to be exactly what we need.&lt;/p&gt;
&lt;p&gt;Flask-sse uses Redis &lt;a class="reference external" href="http://redis.io/topics/pubsub"&gt;pubsub&lt;/a&gt; as a backend for broadcasting the events from the server.
It uses &lt;a class="reference external" href="http://redis.io/topics/cluster-spec"&gt;redis-cluster&lt;/a&gt; which is currently in beta, but &lt;a class="reference external" href="http://antirez.com/news/79"&gt;will be released soon&lt;/a&gt; (and is actually already used in production as reported by Salvatore Sanfilippo).
Flask-sse on top of redis-cluster allows us to have a high available, scalable web service.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="use-case"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;Use-case&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;A possible use-case can be drawn as follows:&lt;/p&gt;
&lt;img alt="pushserver use-case from the user perspective" class="align-center" src="http://developer.paylogic.com/images/pushserver/diagram-user-perspective.png"/&gt;
&lt;p&gt;The actor changes some data on the backend via a normal request to the backend. All users receive the broadcasted
message from the backend via long-lasting channel for server-sent events.&lt;/p&gt;
&lt;p&gt;The deployment may look like this:&lt;/p&gt;
&lt;img alt="pushserver use-case possible deployment schema" class="align-center" src="http://developer.paylogic.com/images/pushserver/diagram-deployment.png"/&gt;
&lt;/div&gt;
&lt;div class="section" id="sending-events-to-a-push-server"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;Sending events to a push server&lt;/a&gt;&lt;/h2&gt;
&lt;pre class="literal-block"&gt;
from flask.ext.sse import send_event

send_event('myevent', {"message": "Hello!"}, channel='mychannel')
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="receiving-events-in-the-browser"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;Receiving events in the browser&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;On the client side you just need a javascipt handler function which will be called when a new message is pushed from the
server.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
var source = new EventSource('/stream?channel=mychannel');
source.addEventListener('myevent', function (event) {
     alert(event.data);
};
&lt;/pre&gt;
&lt;p&gt;Server-Sent Events are &lt;a class="reference external" href="http://caniuse.com/#feat=eventsource"&gt;supported&lt;/a&gt; by recent Firefox, Chrome and Safari
browsers. Internet Explorer does not yet support Server-Sent Events but there are two recommended Polyfills to support
IE and older browsers:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/remy/polyfills/blob/master/EventSource.js"&gt;EventSource.js&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/rwldrn/jquery.eventsource"&gt;jquery.eventsource&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Mobile browsers have limited support, so test carefully whether it works for your target set of browsers.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="live-demo"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;Live demo&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Here is a small demo video of the potential of this technique: we use pushserver to update the ticket availability in
our Frontoffice application. The left and right windows are operated by different users and are completely independent.
When the ticket availability is changed by an action from the left window's operator, the right window changes instantly
without any polling involved (you can see the network bar).&lt;/p&gt;
&lt;p&gt;A simple Frontoffice where you can only select the quantity of tickets:&lt;/p&gt;
&lt;video controls="" height="480" poster="/images/pushserver/pushserver-in-action.png" preload="none" src="/videos/pushserver-in-action.mov" width="720"&gt;&lt;/video&gt;&lt;p&gt;A More advanced example where you can pick a seat:&lt;/p&gt;
&lt;video controls="" height="480" poster="/images/pushserver/pushserver-seating-demo.png" preload="none" src="/videos/pushserver-seating-demo.mov" width="720"&gt;&lt;/video&gt;&lt;/div&gt;
&lt;div class="section" id="future-considerations-for-paylogic"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;Future considerations for Paylogic&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;We are considering creating a special stream API where API users can subscribe to events and get them instantly instead
of needing to poll the state from time to time. This is especially important for things like collecting the result of
payment processing, ticket availability changes, etc.&lt;/p&gt;
&lt;p&gt;For now, Server sent events are more like an experiment for us, but it's a promising technology. We're eager to hear
some feedback from developers who use our API on whether it will be useful for them to have a stream API.&lt;/p&gt;
&lt;/div&gt;
</summary><category term="open source"></category><category term="python"></category><category term="redis-cluster"></category><category term="push notifications"></category><category term="server-sent events"></category><category term="SSE"></category><category term="html5"></category><category term="pub/sub"></category></entry><entry><title>How we use pytest and pytest-bdd in Paylogic.</title><link href="http://developer.paylogic.com/articles/how-we-use-pytest-and-pytest-bdd-in-paylogic.html" rel="alternate"></link><updated>2014-10-31T11:00:00+01:00</updated><author><name>Andrey Makhnach</name></author><id>tag:developer.paylogic.com,2014-10-31:articles/how-we-use-pytest-and-pytest-bdd-in-paylogic.html</id><summary type="html">&lt;div class="section" id="how-we-use-pytest-and-pytest-bdd-in-paylogic"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id1"&gt;How we use pytest and pytest-bdd in Paylogic&lt;/a&gt;&lt;/h2&gt;

&lt;p&gt;After some time of using &lt;a class="reference external" href="http://pytest.org"&gt;pytest&lt;/a&gt; and &lt;a class="reference external" href="https://github.com/olegpidsadnyi/pytest-bdd"&gt;pytest-bdd&lt;/a&gt;
in Paylogic we developed some standards in the structure of folders with tests and fixtures, and the usage of pytest
and pytest-bdd functionality. This article describes those standards and our usage patterns.&lt;/p&gt;
&lt;div class="section" id="folder-structure"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id2"&gt;Folder structure&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;All our tests are stored in the tests folder in the root of the project folder. Our tests are separated by category,
such as unit, functional, blackbox, etc. The tests are stored in the folders of their category. The
structure looks as follows:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
tests/

    fixtures/

    blackbox/

    functional/

    unit/

    conftest.py
&lt;/pre&gt;
&lt;p&gt;In &lt;em&gt;tests/conftest.py&lt;/em&gt; we register all global fixtures that represent objects, such as &lt;em&gt;event&lt;/em&gt;, &lt;em&gt;order&lt;/em&gt; and &lt;em&gt;merchant&lt;/em&gt;.
Here we also register fixtures that represent attributes of objects like event_title, product_title, etc. The fixtures
which are related to pytest-bdd, for example &lt;em&gt;pytestbdd_window_size&lt;/em&gt;, &lt;em&gt;pytestbdd_browser_load_timeout&lt;/em&gt;, etc., are also
registered in &lt;em&gt;tests/conftest.py&lt;/em&gt; because they are common fixtures for both our functional as well as our blackbox tests.&lt;/p&gt;
&lt;p&gt;I use the term "common fixtures" because &lt;em&gt;conftest.py&lt;/em&gt; gives us the possibility to separate fixtures and pytest's plugins
hooks, and register them only for those tests that use them. In our case, we have fixtures/hooks which are
common for all tests and at the same time we have fixtures/hooks which are related only to functional/blackbox tests,
for example &lt;em&gt;pytestbdd_window_size&lt;/em&gt;. You can imagine that this fixture is only used by pytest-bdd and not by our unit tests.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fixture-imports"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id3"&gt;Fixture imports&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;For registering fixtures we just import the fixtures from their packages. For example for registering the &lt;em&gt;order&lt;/em&gt; fixture
and fixtures that represent attributes of &lt;em&gt;order&lt;/em&gt; object such as &lt;em&gt;order_title&lt;/em&gt;, &lt;em&gt;order_point_of_sale&lt;/em&gt;, etc. we just do:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;tests.fixtures.order&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;order&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;order_title&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;order_point_of_sale&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="o"&gt;...&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;A fixture that represents an object, e.g. an order, typically looks as follows:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nd"&gt;@pytest.fixture&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;order&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;order_point_of_sale&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;order_products&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="n"&gt;expiry_time&lt;/span&gt;
&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Fixture which represents an order object."""&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;create_test_order&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
        &lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;point_of_sale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;order_point_of_sale&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;products&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;order_products&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
        &lt;span class="n"&gt;expiry_time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;expiry_time&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you can see our order fixture is a regular pytest fixture, nothing special. It returns an instance of the Order
model which in turn is created by the &lt;em&gt;create_test_order&lt;/em&gt; testhelper function.&lt;/p&gt;
&lt;p&gt;We are using testhelper functions for creating fixtures and for populating the database with initial data after
re-creating it. We use testhelpers instead of loading JSON or YAML fixtures because attributes of models change
frequently and we decided that it would be better and more flexible to use just a list of testhelpers that are called in
the right order for creating initial data.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fixture-parametrization"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id4"&gt;Fixture parametrization&lt;/a&gt;&lt;/h3&gt;
&lt;div class="section" id="overriding-fixture-parameters"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="#id5"&gt;Overriding fixture parameters&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;The order fixture inherits from lots of other fixtures because we want to have the possibility to override attributes
with which the order will be created. We override these using @pytest.mark.parametrize or with argumented steps in
pytest-bdd.&lt;/p&gt;
&lt;p&gt;For example if we need to test an order with a different &lt;em&gt;expiry_time&lt;/em&gt; we do it like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pytest&lt;/span&gt;

&lt;span class="nd"&gt;@pytest.mark.parametrize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;expiry_time&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;
        &lt;span class="n"&gt;datetime&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;date&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;now&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;datetime&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timedelta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;days&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="n"&gt;datetime&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;date&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;now&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;datetime&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timedelta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;days&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_complete_order&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;order&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;order&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;complete&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;order&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;OrderState&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;COMPLETED&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now, test_complete_order test will be executed twice and every time we will have an order with a different &lt;em&gt;expiry_time&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;We also use &lt;em&gt;pytest.fixture(params=[...])&lt;/em&gt; to set parameters for fixtures:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pytest&lt;/span&gt;

&lt;span class="nd"&gt;@pytest.fixture&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'127.0.0.1'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'192.168.0.1'&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;client_ip&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;param&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;From the example you can see that as soon as we run tests that use the &lt;em&gt;client_ip&lt;/em&gt; fixture then pytest will run this
test as many times as the number of parameters the &lt;em&gt;client_ip&lt;/em&gt; fixture has defined (in this case of course two).&lt;/p&gt;
&lt;p&gt;Now the question is of course, what is the difference between those two parametrization methods? The difference is that
&lt;em&gt;pytest.mark.parametrize&lt;/em&gt; will influence only the test on which it is explicitly defined, while &lt;em&gt;pytest.fixture(params=[..])&lt;/em&gt;
influences every test that uses this fixture. If you would for example define three parameters for the above client_ip fixture,
then each test using this fixture will now be executed three times, once for every param. You are basically creating
three fixtures.&lt;/p&gt;
&lt;p&gt;Regarding how frequently you would use &lt;em&gt;pytest.mark.parametrize&lt;/em&gt; compared of &lt;em&gt;pytest.fixture(params=[...])&lt;/em&gt;, it strongly
depends on your code base, test code base and type of test. I don't think I can say anything meaningful about that in a
general sense based on just our experiences.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fixtures-for-mocking"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="#id6"&gt;Fixtures for mocking&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;We also use fixtures for mocking. For example in the &lt;a class="reference external" href="https://github.com/paylogic/settei"&gt;settei&lt;/a&gt;  project we needed
to mock a required method of the &lt;em&gt;pkg_resources.EntryPoint&lt;/em&gt; class, so we wrote the following fixture:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# tests/test_get_entry_points.py&lt;/span&gt;
&lt;span class="o"&gt;...&lt;/span&gt;
&lt;span class="nd"&gt;@pytest.fixture&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;monkeypatch_entrypoint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;monkeypatch&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;clean_config&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Monkeypatching EntryPoint."""&lt;/span&gt;
    &lt;span class="n"&gt;monkeypatch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;setattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pkg_resources&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EntryPoint&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'require'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;require&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="err"&gt;…&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Each time when your tests depends on this fixture, the &lt;em&gt;require&lt;/em&gt; method of the
&lt;em&gt;pkg_resources.EntryPoint&lt;/em&gt; class would be mocked.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="functional-testing"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id7"&gt;Functional testing&lt;/a&gt;&lt;/h3&gt;
&lt;div class="section" id="parametrizing-scenarios"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="#id8"&gt;Parametrizing scenarios&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;We also use &lt;em&gt;pytest.mark.parametrize&lt;/em&gt; for functional testing with pytest-bdd. If you for example need to test the functionality of
creating a product, the scenario of successfully creating a product can look like this:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Scenario: Successfully creating a product
Given I am a backoffice admin
And I have an event

When I go to the New product page
And I fill in the name of the product
And I fill in the quantity of the product equal to 5
And I submit the form

Then I should see a success message
&lt;/pre&gt;
&lt;p&gt;As you can see, nothing special. But if you for example need to test that a form should show an error message if the
quantity of the product cannot equal 0, then you will create another scenario. It can look like this:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Scenario: Unsuccessful creating of product
Given I am a backoffice admin
And I have an event

When I go to the New product page
And I fill in the name of the product
And I fill in the quantity of the product equal to 0
And I submit the form

Then I should see an error message
&lt;/pre&gt;
&lt;p&gt;As we can see there is a lot of double work here, which is something we should try to avoid. Luckily, there is a solution. Let's merge
these two scenarios into one:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Scenario: Create product
Given I am a backoffice admin
And I have an event

When I go to the New product page
And I fill the name of product
And I fill in the quantity of the product equal to &amp;lt;product_quantity&amp;gt;
And I submit the form

Then I should see a &amp;lt;message_status&amp;gt; message
&lt;/pre&gt;
&lt;p&gt;Then in your tests file you can define the scenario like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pytest&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pytest_bdd&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;scenario&lt;/span&gt;

&lt;span class="nd"&gt;@pytest.mark.parametrize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'product_quantity'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'message_status'&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'success'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'error'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="nd"&gt;@scenario&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'Create product'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_create_product&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;product_quantity&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;message_status&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="sd"&gt;"""Create product."""&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And now in your given, when and then steps you can ask for the &lt;em&gt;product_quantity&lt;/em&gt; and &lt;em&gt;message_status&lt;/em&gt; fixtures.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nd"&gt;@when&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'I fill in the quantity of the product equal to &amp;lt;product_quantity&amp;gt;'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;i_fill_the_quantity_of_product&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;product_quantity&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="err"&gt;…&lt;/span&gt;

&lt;span class="nd"&gt;@then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'I should see a &amp;lt;message_status&amp;gt; message'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;assert_that_i_see_message&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;message_status&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="err"&gt;…&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There is one more thing which we also use in testing, which is the step with arguments (or argumented steps).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="steps-with-arguments"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="#id9"&gt;Steps with arguments&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;Consider that, for some reason, you have a similar step in several scenarios, for example &lt;em&gt;"Given I have an event with
2 products"&lt;/em&gt; and &lt;em&gt;"Given I have an event with 5 products"&lt;/em&gt;. In your test files you will then have two different steps
defined that are actually almost the same. There is a solution which can help you use the same step for several
scenarios with different behaviour.&lt;/p&gt;
&lt;p&gt;In your scenarios you just write &lt;em&gt;"Given I have an event with 2 products"&lt;/em&gt; and &lt;em&gt;"Given I have an event with 5 products"&lt;/em&gt;, as
you did before, but in your given.py file you write the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;re&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pytest_bdd&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;given&lt;/span&gt;

&lt;span class="nd"&gt;@given&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;compile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'I have an event with (?P&amp;lt;product_quantity&amp;gt;\d+) products'&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;i_have_an_event_with_products&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;product_quantity&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""I have an event with products."""&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now, if your event fixture uses the &lt;em&gt;product_quantity&lt;/em&gt; fixture, then for each scenario you will get the event with a
different quantity of products, depending on what you write in your feature file.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="scenario-outlines"&gt;
&lt;h4&gt;&lt;a class="toc-backref" href="#id10"&gt;Scenario outlines&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;Scenarios can also be parametrized to cover multiple cases. In the &lt;a class="reference external" href="http://docs.behat.org/en/v2.5/guides/1.gherkin.html"&gt;Gherkin language&lt;/a&gt;
the variable templates are written using corner braces, like so: &amp;lt;somevalue&amp;gt;. Scenario outlines are supported by pytest-bdd
exactly as described in the &lt;a class="reference external" href="http://docs.behat.org/en/v2.5/guides/1.gherkin.html#scenario-outlines"&gt;behave docs&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;A full example of a scenario outline can be found below.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Scenario Outline: Outlined given, when, thens
Given there are &amp;lt;start&amp;gt; cucumbers
When I eat &amp;lt;eat&amp;gt; cucumbers
Then I should have &amp;lt;left&amp;gt; cucumbers

Examples:
| start | eat | left |
|  12   |  5  |  7   |
&lt;/pre&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pytest_bdd&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;given&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;when&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;then&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scenario&lt;/span&gt;

&lt;span class="nd"&gt;@scenario&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="s"&gt;'outline.feature'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s"&gt;'Outlined given, when, thens'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;example_converters&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;eat&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;float&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;left&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_outlined&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;span class="k"&gt;pass&lt;/span&gt;


&lt;span class="nd"&gt;@given&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'there are &amp;lt;start&amp;gt; cucumbers'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;start_cucumbers&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="nd"&gt;@when&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'I eat &amp;lt;eat&amp;gt; cucumbers'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;eat_cucumbers&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start_cucumbers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;eat&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;eat&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;float&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;start_cucumbers&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'eat'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;eat&lt;/span&gt;


&lt;span class="nd"&gt;@then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'I should have &amp;lt;left&amp;gt; cucumbers'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;should_have_left_cucumbers&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start_cucumbers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;eat&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;left&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;left&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;eat&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;left&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;start_cucumbers&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'start'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt;
    &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;start_cucumbers&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'eat'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;eat&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This code also shows the possibility to use converters which may be useful if you need parameter
types different than strings.&lt;/p&gt;
&lt;p&gt;There are two types of outlines, namely horizontal and vertical. These merely
state how you write the possible values of the attributes. We saw an example of
a horizontal outline above; the below is an example of a vertical outline. Note
that you have to explicitly state "Vertical" to indicate that you are using the
vertical outline type, otherwise pytest-bdd will default to horizontal.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Scenario Outline: Outlined given, when, thens
Given there are &amp;lt;start&amp;gt; cucumbers
When I eat &amp;lt;eat&amp;gt; cucumbers
Then I should have &amp;lt;left&amp;gt; cucumbers

Examples: Vertical
| start | 12 | 2 |
| eat   | 5  | 1 |
| left  | 7  | 1 |
&lt;/pre&gt;
&lt;p&gt;Finally, you should not forget to register the given steps from &lt;em&gt;functional/steps/given.py&lt;/em&gt; in
&lt;em&gt;functional/conftest.py&lt;/em&gt; in the functional folder.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# tests/functional/conftest.py&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;tests.functional.steps.given&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now your folder structure should look like this:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
tests/
    fixtures/

    blackbox/

    functional/
        steps
            __init__.py
            given.py
        conftest.py
    unit/
    conftest.py
&lt;/pre&gt;
&lt;p&gt;All things registered in &lt;em&gt;tests/functional/conftest.py&lt;/em&gt; will now only be accessible in the scope of the functional tests.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id11"&gt;Conclusion&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;That is how our core of storing/creating our tests looks like. I hope that this article will
be useful for you. There are always ways to improve it and you are welcome in comments with your thoughts. We are
planning to improve a relation between code and tests, fixtures.&lt;/p&gt;
&lt;p&gt;Thank you for reading.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="open source"></category><category term="python"></category><category term="pytest"></category><category term="pytest-bdd"></category></entry><entry><title>Traduki</title><link href="http://developer.paylogic.com/articles/traduki.html" rel="alternate"></link><updated>2014-10-27T10:00:00+01:00</updated><author><name>Spyros Ioakeimidis</name></author><id>tag:developer.paylogic.com,2014-10-27:articles/traduki.html</id><summary type="html">
&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id1"&gt;Introduction&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt; is an &lt;a class="reference external" href="https://github.com/paylogic/traduki"&gt;open source&lt;/a&gt;
package, which consists of internationalization helper classes targeted for
SQLAlchemy-based python projects. The advantage of using &lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt; is that
it removes the burden of defining translation tables, and provides
a consistent, intuitive and easy way to introduce internationalization into
your application. Minimalistic design allowed us to use only
&lt;a class="reference external" href="http://www.sqlalchemy.org/"&gt;SQLAlchemy&lt;/a&gt; as a python dependency.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="why-we-were-in-a-need-of-something-different"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id2"&gt;Why we were in a need of something different&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As Paylogic operates in several countries, internationalization is a strong
requirement. However, we used to do internationalization differently from how
we do it these days. Our former approach was to join translation tables in order
to obtain the translations. This allowed us to search on the internationalized
fields, but it required a lot of joins, even in cases where searching was not a requirement.
We could either &lt;a class="reference external" href="http://docs.sqlalchemy.org/en/rel_0_9/orm/tutorial.html#eager-loading"&gt;eager load&lt;/a&gt;,
load relationships at the same time the parent is loaded, or
&lt;a class="reference external" href="http://docs.sqlalchemy.org/en/rel_0_9/glossary.html#term-lazy-loading"&gt;lazy load&lt;/a&gt;,
load relationships the first time they are accessed. When we lazy load,
and access an internationalized property, we cause two queries per property.&lt;/p&gt;
&lt;p&gt;One of these queries is to the translations table, and the other one
to a table with only the ids. The translations table had one translation per
row, which made it inefficient and difficult to get all the translations for
all the properties in one row. For example,&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="9%"&gt;&lt;/col&gt;
&lt;col width="34%"&gt;&lt;/col&gt;
&lt;col width="20%"&gt;&lt;/col&gt;
&lt;col width="36%"&gt;&lt;/col&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head" colspan="4"&gt;Translation&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;th class="head"&gt;id&lt;/th&gt;
&lt;th class="head"&gt;language_code&lt;/th&gt;
&lt;th class="head"&gt;text_id&lt;/th&gt;
&lt;th class="head"&gt;localized_text&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;en&lt;/td&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;td&gt;English title 1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;nl&lt;/td&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;td&gt;Dutch title 1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;en&lt;/td&gt;
&lt;td&gt;11&lt;/td&gt;
&lt;td&gt;English subtitle&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;nl&lt;/td&gt;
&lt;td&gt;11&lt;/td&gt;
&lt;td&gt;Dutch subtitle&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;en&lt;/td&gt;
&lt;td&gt;12&lt;/td&gt;
&lt;td&gt;English title 2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;6&lt;/td&gt;
&lt;td&gt;nl&lt;/td&gt;
&lt;td&gt;12&lt;/td&gt;
&lt;td&gt;Dutch title 2&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;where the &lt;code&gt;text_id&lt;/code&gt; references the &lt;code&gt;title_id&lt;/code&gt; and
&lt;code&gt;subtitle_id&lt;/code&gt; fields from a hypothetical &lt;code&gt;Event&lt;/code&gt; table.&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="15%"&gt;&lt;/col&gt;
&lt;col width="37%"&gt;&lt;/col&gt;
&lt;col width="48%"&gt;&lt;/col&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head" colspan="3"&gt;Event&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;th class="head"&gt;id&lt;/th&gt;
&lt;th class="head"&gt;title_id&lt;/th&gt;
&lt;th class="head"&gt;subtitle_id&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;td&gt;11&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;12&lt;/td&gt;
&lt;td&gt;13&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;This approach was inefficient because for &lt;tt class="docutils literal"&gt;n&lt;/tt&gt; properties and &lt;tt class="docutils literal"&gt;m&lt;/tt&gt;
languages, we would need to do &lt;tt class="docutils literal"&gt;n*m&lt;/tt&gt; joins. The difficult part comes from
the fact that it was cumbersome to write those queries. In the case of
the previous example,&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;a_alias&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;aliased&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Translation&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;q&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Event&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;\
    &lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Translation&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;\
    &lt;span class="nb"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Translation&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;text_id&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="n"&gt;Event&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title_id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;\
    &lt;span class="nb"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a_alias&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;text_id&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="n"&gt;Event&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;subtitle_id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;\
    &lt;span class="nb"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Event&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;in_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;event_ids&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;\
    &lt;span class="nb"&gt;all&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The end-result was that we did not do this, and we were doing more one-row queries.
We should mention that normally we don't need objects to have dynamic list
of available languages. Maybe it is a strict requirement in other use cases,
but in our use case it is enough to just use a static set of available languages,
which change infrequently.&lt;/p&gt;
&lt;p&gt;Another issue with this approach was that the number of results returned from
queries was not deterministic, and required left joins which is even worse
performance-wise. Most of the time you want to eager load relationships.
However, in this case you can never apply a limit or offset because you cannot
trust the number of rows returned.&lt;/p&gt;
&lt;p&gt;The aforementioned approach had performance issues. We wanted to be able to
search on the internationalized fields and search fast, which was not possible.
Another requirement was that we wanted language chains. What this means is that
if your language is Dutch, but only the English version of the text is
available, we should display by default the English version of it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="advantages-of-the-new-design"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;Advantages of the new design&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;In the end, taking into consideration our motivation and requirements, we came up
with our solution on how to solve the problem of i18n. The following
example illustrates our current approach using &lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt;. Let's assume that we
have a table &lt;code&gt;Event&lt;/code&gt;, and we want the &lt;tt class="docutils literal"&gt;title&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;subtitle&lt;/tt&gt; to be
translated into English and Dutch. The &lt;code&gt;Event&lt;/code&gt; table contains the ids of
the fields that we wish to have available in those two languages. Let's also
assume that for the event with &lt;code&gt;id = 8&lt;/code&gt;, the Dutch translation is not
available.&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="15%"&gt;&lt;/col&gt;
&lt;col width="37%"&gt;&lt;/col&gt;
&lt;col width="48%"&gt;&lt;/col&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head" colspan="3"&gt;Event&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;th class="head"&gt;id&lt;/th&gt;
&lt;th class="head"&gt;title_id&lt;/th&gt;
&lt;th class="head"&gt;subtitle_id&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;td&gt;11&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;...&lt;/td&gt;
&lt;td&gt;...&lt;/td&gt;
&lt;td&gt;...&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;8&lt;/td&gt;
&lt;td&gt;25&lt;/td&gt;
&lt;td&gt;26&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;The &lt;code&gt;Translation&lt;/code&gt; table would then contain a reference to those fields
that we wish to have translated. The &lt;code&gt;id = 10&lt;/code&gt; for the &lt;tt class="docutils literal"&gt;title&lt;/tt&gt; and
&lt;code&gt;id = 11&lt;/code&gt; for the &lt;tt class="docutils literal"&gt;subtitle&lt;/tt&gt; of the first event, and &lt;code&gt;id = 25&lt;/code&gt;
and &lt;code&gt;id = 26&lt;/code&gt; for the &lt;tt class="docutils literal"&gt;title&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;subtitle&lt;/tt&gt; for the second event
respectively. It also contains the translated texts in English and Dutch
(only for the first event). With this approach, we can easily get the
translated texts by joining the &lt;code&gt;Event&lt;/code&gt; and &lt;code&gt;Translation&lt;/code&gt; tables.&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="10%"&gt;&lt;/col&gt;
&lt;col width="45%"&gt;&lt;/col&gt;
&lt;col width="45%"&gt;&lt;/col&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head" colspan="3"&gt;Translation&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;th class="head"&gt;id&lt;/th&gt;
&lt;th class="head"&gt;en&lt;/th&gt;
&lt;th class="head"&gt;nl&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;10&lt;/td&gt;
&lt;td&gt;English title 1&lt;/td&gt;
&lt;td&gt;Dutch title 1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;11&lt;/td&gt;
&lt;td&gt;English subtitle 1&lt;/td&gt;
&lt;td&gt;Dutch subtitle 1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;...&lt;/td&gt;
&lt;td&gt;...&lt;/td&gt;
&lt;td&gt;...&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;25&lt;/td&gt;
&lt;td&gt;English title 2&lt;/td&gt;
&lt;td&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;26&lt;/td&gt;
&lt;td&gt;English subtitle 2&lt;/td&gt;
&lt;td&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;The advantage of this approach is that with a simple join between these tables
on the id of the text (for example the &lt;tt class="docutils literal"&gt;title_id&lt;/tt&gt;), we get one row with all
the translations.&lt;/p&gt;
&lt;pre class="code python literal-block"&gt;
&lt;span class="n"&gt;q&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Translation&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Event&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Event&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title_id&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="n"&gt;Translation&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;As can be seen from the query, for &lt;tt class="docutils literal"&gt;n&lt;/tt&gt; properties and &lt;tt class="docutils literal"&gt;m&lt;/tt&gt; languages,
the number of joins is reduced from &lt;tt class="docutils literal"&gt;n*m&lt;/tt&gt; to &lt;tt class="docutils literal"&gt;n&lt;/tt&gt;, making them also more
intuitive since all translated items are foreign keys to the &lt;code&gt;Translation&lt;/code&gt;
table, joining once per foreign key. Additionally, &lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt; returns a user-friendly
format of this result as a dictionary of language codes and translations. For example:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;'en'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'English title 1'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'nl'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Dutch title 1'&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In case of the second event, where the Dutch translation is not available,
&lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt; falls back to the language that we have defined, in this
case English. So it will return:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;'en'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'English title 2'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'nl'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'English title 2'&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This approach has one drawback. When a new language is introduced then we need
to alter the translations table to include it. Although this operation can be expensive,
we found out that the gains in performance are higher, because we search and sort much
more often than we add new languages. Also, for us it is more important to have a static
set of available languages than actually adding new languages.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="how-it-works"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;How it works&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt; is very simple to use. The following example is a concise and
stand-alone application that illustrates the use of &lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt;. It is
split in parts, to better explain how each part works.&lt;/p&gt;
&lt;div class="section" id="example"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id5"&gt;Example&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The first part is straightforward. We do standard sqlalchemy imports,
create the engine (in this case the database will be in memory), and define the
declarative base for our models.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;traduki&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;create_engine&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Column&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy.ext.declarative&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;declarative_base&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy.orm&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;sessionmaker&lt;/span&gt;

&lt;span class="n"&gt;engine&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;create_engine&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'sqlite://'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;Base&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;declarative_base&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The next part is where &lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt; is used. We define two callbacks, one
for getting the current language and one for getting the language chain. Here
we just return hard coded data for simplicity. We could read this data from a
current &lt;tt class="docutils literal"&gt;request&lt;/tt&gt; object, for example using &lt;a class="reference external" href="http://flask.pocoo.org/"&gt;Flask&lt;/a&gt;
request, something like &lt;code&gt;flask.request.locale&lt;/code&gt; to get the current language.
We use these callbacks when we deal with the initialization of the &lt;code&gt;i18n_attributes&lt;/code&gt;.
&lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt; at the moment of initialization declares the model for the translations
dynamically and sets up all the appropriate relationships.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;get_current_language&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;"""Current language callback for our project."""&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s"&gt;'en'&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;get_language_chain&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;"""Language chain (fall-back rule) callback for our project."""&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;'*'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'en'&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;i18n_attributes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;traduki&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;initialize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;Base&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'en'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'nl'&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;get_current_language&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;get_language_chain&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The language list that we pass to &lt;code&gt;traduki.initialize&lt;/code&gt; function is used
to declare language columns in translations model. So if we use &lt;code&gt;['en', 'nl']&lt;/code&gt;
the resulting translations model would be something similar to the following declaration.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Translation&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Base&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="n"&gt;__tablename__&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;'traduki_translation'&lt;/span&gt;

    &lt;span class="nb"&gt;id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Column&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;primary_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;en&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Column&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;UnicodeText&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;nullable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;nl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Column&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;UnicodeText&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;nullable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Back to our example, we define our model and use the column and relation provided by
&lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt;. The rest is just to have a complete and running example.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Base&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="n"&gt;__tablename__&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;'model'&lt;/span&gt;

    &lt;span class="nb"&gt;id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Column&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;primary_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;title_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;i18n_attributes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;i18n_column&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nullable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;unique&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;title&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;i18n_attributes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;i18n_relation&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;title_id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="sd"&gt;"""Title."""&lt;/span&gt;

&lt;span class="n"&gt;Base&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;metadata&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;create_all&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;engine&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;Session&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sessionmaker&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bind&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;engine&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;session&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Session&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;'en'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'English title'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'nl'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Dutch title'&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;commit&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;refresh&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_dict&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;'en'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'English title'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'nl'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;'Dutch title'&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;en&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;'English title'&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To run this example, copy and paste these parts in an &lt;tt class="docutils literal"&gt;example.py&lt;/tt&gt; file, and
use the following commands to install the required packages and run the
example:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;virtualenv env

&lt;span class="nb"&gt;source &lt;/span&gt;env/bin/activate

pip install sqlalchemy traduki

python example.py
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="querying"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id6"&gt;Querying&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Querying translations can also be done using usual SQLAlchemy techniques.
From the previous example, lets assume that we want to get all &lt;code&gt;Model&lt;/code&gt;
instances that have English translation for their &lt;code&gt;title&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;english_title_objects&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;i18n_attributes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Translation&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title_id&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;i18n_attributes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Translation&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i18n_attributes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Translation&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;en&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;isnot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;all&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code&gt;i18n_attributes.Translation&lt;/code&gt; is the translations model declared during initialization
of &lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt;. It provides helper methods to get the text of a specified language
and get the available languages as a dictionary. It also contains language fields as attributes,
which is nice as it enables directly attribute access to get a language for a specific field
&lt;code&gt;model.title.en&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="the-difference-from-sqlalchemy-i18n"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;The difference from SQLAlchemy-i18n&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;We conducted research on how to make an efficient design. We tried lots of
ways to minimize the timing of the queries for large datasets. Also we've looked
around for existing solutions and we found &lt;a class="reference external" href="https://github.com/kvesteri/sqlalchemy-i18n"&gt;SQLAlchemy-i18n&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The approach of this project is to create a separate translations table and each row in the table
is a translation in a specific language for a specific field. This is similar to our
previous approach and has the same limitations in performance. You need to explicitly
query for languages and fields and do lots of joins. What &lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt; does, is load all the languages
and translations for a field. This might sound like a lot of overhead at first, but in modern
applications you usually have 10-12 languages and you want them to be available all at once in
the client.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;In general, not much has been done on i18n in open source. We hope that &lt;tt class="docutils literal"&gt;traduki&lt;/tt&gt; will prove
useful for projects that require an efficient and easy to use internationalization system.
We are waiting for your feedback and recommendations. Check &lt;a class="reference external" href="https://github.com/paylogic/traduki"&gt;traduki&lt;/a&gt;
in our github profile.&lt;/p&gt;
&lt;/div&gt;
</summary><category term="internationalization"></category><category term="sqlalchemy"></category><category term="python"></category><category term="database"></category><category term="i18n"></category></entry><entry><title>Lessons learned using SCRUM</title><link href="http://developer.paylogic.com/articles/lessons-scrum.html" rel="alternate"></link><updated>2014-10-09T10:28:00+02:00</updated><author><name>Lars de Ridder</name></author><id>tag:developer.paylogic.com,2014-10-09:articles/lessons-scrum.html</id><summary type="html">
&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id1"&gt;Introduction&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Paylogic has been using &lt;a class="reference external" href="https://www.scrum.org/"&gt;SCRUM&lt;/a&gt; for its engineering process for years now.
We've made quite a bunch of changes throughout this time and learned a lot.
Right now we have a highly repeatable and predictable development process, which
makes it very easy for new engineers to start and almost guarantees that a
commitment will be met. I would like to share some of the most important things
we've learned along the way.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="when-doing-scrum-do-scrum"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id2"&gt;When doing SCRUM, do SCRUM&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;There are way too many companies out there doing something and calling it SCRUM
(or agile), and not actually doing it. You have the opportunity to stand on the
shoulders of giants. Use those giants, especially when just getting started.
Understand why things are done, and only then modify if needed. Avoid &lt;a class="reference external" href="https://www.scrum.org/scrumbut"&gt;ScrumButs&lt;/a&gt;
as much as possible.&lt;/p&gt;
&lt;p&gt;And if it turns out you don't like SCRUM, use something else, but don't play
pretend.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="there-really-isn-t-much-process"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;There really isn't much process&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;There's some, more than with ad hoc programming, and a bit more than with
&lt;a class="reference external" href="http://en.wikipedia.org/wiki/Kanban_%28development%29"&gt;Kanban&lt;/a&gt;, but definitely not a lot.&lt;/p&gt;
&lt;p&gt;At Paylogic, in an average two week sprint with three teams of in total 14
engineers, we spend two hours on sprint planning, half an hour per team on
backlog grooming, about 20 minutes on the sprint demo and about 40 minutes on
the sprint retrospective. Then we of course have standups, which take about 10
minutes per day and are done on all days except for the sprint planning day.&lt;/p&gt;
&lt;p&gt;This totals to five hours of process per person per two weeks, or two and a half
hours per week. Based on a 40 hour work week, that's about 6%.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-process-that-exists-is-good"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;The process that exists is good!&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Now 6% is all well and good, but every bit of process is too much if it has no
outcome. However, the structure of SCRUM merely asks you to do what you should
be doing already. Basically, you should:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Work in iterations;&lt;/li&gt;
&lt;li&gt;Make a plan for each iteration so that the business knows what's coming;&lt;/li&gt;
&lt;li&gt;Keep each other updated on your progress and your issues;&lt;/li&gt;
&lt;li&gt;Show off what you created; and&lt;/li&gt;
&lt;li&gt;Evaluate your iteration and take action to improve.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I find it hard to find fault in any of those steps, and they are basically the
only steps you have to do to implement SCRUM.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="timebox-your-meetings"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;Timebox your meetings&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Meetings have a tendency to drag on (see also &lt;a class="reference external" href="http://en.wikipedia.org/wiki/Parkinson%27s_law"&gt;Parkinson's Law&lt;/a&gt;). It's fairly
simple to prevent this however.&lt;/p&gt;
&lt;p&gt;In all SCRUM meetings (and most productive meetings actually), you are dealing
with a number of consecutive items, and when all are handled you're done. In the
case of the sprint planning each item is every story that fits in the sprint,
and in the case of a standup it's each member of the team. Simply set a deadline
for each item and track and enforce this deadline. People will focus on the most
important points to most optimally use their time, and after a few times, almost
no-one will get even near to the deadline.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="team-members-should-be-in-charge-of-their-individual-velocity"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;Team members should be in charge of their individual velocity&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Engineers take pride in doing their work well. Creation is in our blood. It
should be natural to leave it up to the engineer to determine the speed in which
they feel they work, or want to work. Velocity should not automatically be
computed by a script or mandated by a team leader, and should not be averaged
out over a team. It is important to recognize the individuals in a team, and
they should have the opportunity to set their own velocity based on past results
and future ambitions.&lt;/p&gt;
&lt;p&gt;Next to that, it also makes planning a lot easier. If you have 80 story points
available in a sprint, it usually doesn't mean that you can plan a single story
estimated on 80 story points in that sprint. Work is often not that
parallelizable. If two persons can work on this story, and each person has 20
story points as their own velocity, then it's suddenly simple to see that you
can do 40 story points of that story.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="use-proper-tooling"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;Use proper tooling&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;I wrote an article on &lt;a class="reference external" href="trello.html"&gt;how we use Trello&lt;/a&gt;, but any tool or method that allows
you to visualize the work being done and shows your progress towards the end of
the sprint is fine. Don't skip this; not having it basically means flying blind,
and you won't ever get controlled sprints.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="plan-everything"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;Plan everything&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Don't only plan for the user stories scheduled for a sprint. Recognize that
other work also has to be done. In our case, we had a period where we had to
reduce the commitment every sprint, because one of the engineers had to perform
maintenance on the new Continuous Integration server regularly. Keep monitoring
which work is actually done, and make sure to create space for this work to be
planned as well.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="backlog-grooming-is-essential"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;Backlog grooming is essential&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;We started &lt;a class="reference external" href="http://scrummethodology.com/scrum-backlog-grooming/"&gt;backlog grooming&lt;/a&gt; relatively late, as we didn't think we needed it.
Turns out we did. It's really nobody's fault but the team's if it finds out
during sprint planning that a user story isn't ready for the sprint. And then
there's no time to correct it, with frustrations on all sides.&lt;/p&gt;
&lt;p&gt;Don't try to actually do estimations or even think of tasks during the grooming
sessions. The team should simply review each user story to see if they can work
on it in its current state.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="a-team-also-needs-freedom-when-determining-what-to-do"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;A team also needs freedom when determining what to do&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The product owner is of course responsible for the backlog, but to get good
software, the team needs to be able to influence what they work on as well.  The
team needs some room to, for example, improve its tooling and development
environment and to iterate over earlier designs. It is essential for a product
owner to take this into account.&lt;/p&gt;
&lt;p&gt;If this turns out to be difficult to negotiate, balance can be restored by
allowing the team to schedule a portion of its time (say 10%) by itself,
regardless of the backlog.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="commitment-vs-forecast"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;Commitment vs forecast&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;In the official SCRUM description, there actually exists no such thing as a
commitment. Instead, there is a &lt;a class="reference external" href="https://www.scrum.org/About/All-Articles/articleType/ArticleView/articleId/95/Commitment-vs-Forecast-A-subtle-but-important-change-to-Scrum"&gt;forecast&lt;/a&gt;. The idea of this forecast instead
of commitment is great, the thing is however that often it doesn't matter.
Whether you use the term forecast or commitment, business people will still
expect you to deliver what you said you would deliver. Because that's how they
work.&lt;/p&gt;
&lt;p&gt;There's no real cure for this. Communication is very important here, but in the
end it's just something you should be aware of. Don't expect you can just win
this by changing the term. You'll have to change a mindset, and sometimes even a
culture, and that's much harder.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="multiple-teams-can-scrum-together"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id12"&gt;Multiple teams can SCRUM together&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Having a separate SCRUM team doesn't mean they have to have their own standups
and retrospectives. In fact, that's often a bad idea. If the teams are
completely independent, kind of like different companies, then it's of course
fine. But usually, when you are part of the same company, you work together on
different parts of the same whole, and communication between teams is just as
important as communication within teams.&lt;/p&gt;
&lt;p&gt;In our case, the three teams consist of a total of about 14 members. This is
small enough so that we can still have communal standups and retrospectives.
Sprint planning and backlog grooming are done separately however.&lt;/p&gt;
&lt;p&gt;When teams get larger, a &lt;a class="reference external" href="http://guide.agilealliance.org/guide/scrumofscrums.html"&gt;SCRUM of SCRUMS&lt;/a&gt; can be used to keep communication
going.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="closing-thoughts"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id13"&gt;Closing thoughts&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;At Paylogic we've seen our process grow from being used in a single, small team,
to a single large team, to scaling to three teams. We've seen people come and
go, but the process is still going strong. I am very happy with it and with the
performance of the teams as well.&lt;/p&gt;
&lt;p&gt;Regardless, there are other alternatives that can work just as well, or perhaps
even better. When it comes to raw productivity, I actually think a Kanban
process is just a little bit better. A sprint ending and beginning is still
disruptive and does reduce productivity, more than just the hours spent on the
meetings. Kanban, being a continuous process, doesn't have this.&lt;/p&gt;
&lt;p&gt;It does require more discipline to pull off correctly however, and I believe it
is harder for a newcomer to get started with. I would like to try such a process
in Paylogic however, so perhaps I'll write another article about that by that
time.&lt;/p&gt;
&lt;!-- External references: --&gt;
&lt;/div&gt;
</summary><category term="scrum"></category><category term="agile"></category><category term="project management"></category><category term="scrum master"></category><category term="product owner"></category></entry><entry><title>How we use Trello and custom tooling to streamline our development process</title><link href="http://developer.paylogic.com/articles/trello.html" rel="alternate"></link><updated>2014-10-07T12:05:00+02:00</updated><author><name>Lars de Ridder</name></author><id>tag:developer.paylogic.com,2014-10-07:articles/trello.html</id><summary type="html">
&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id2"&gt;Introduction&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;One of the challenges in the abstract world of code (and at the same time one of
the most rewarding things you can do) is to visualize the work that is being
done and that is left to do. Code is not like buildings that you can see rising
from the ground, and not even like a book that you can count the pages. This
makes it incredibly hard to gauge progress and view the status.&lt;/p&gt;
&lt;p&gt;Luckily we live in a magical world where not only there is such a thing like
code and computers to interpret it, but there are also people building awesome
things with them to solve problems. One of these things is of course Paylogic,
but another (and the thing that we will actually talk about here) is &lt;a class="reference external" href="http://trello.com/"&gt;Trello&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In this article you will see how we at Paylogic use Trello, combined with custom
tooling through the power of API's, to improve our development process.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="in-the-beginning"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;In the beginning&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The world was flat, and Paylogic only used &lt;a class="reference external" href="http://www.fogbugz.com/"&gt;FogBugz&lt;/a&gt;. If you're not familiar
with FogBugz, it's a bug tracking tool created by &lt;a class="reference external" href="http://www.fogcreek.com/"&gt;Fog Creek&lt;/a&gt; that is fairly
easily extensible with &lt;a class="reference external" href="http://www.fogcreek.com/fogbugz/plugins/"&gt;plugins&lt;/a&gt;. Back then, everyone got assigned a case at
the start of the sprint, and you worked on your case until it was finished. When
it was finished, you could ask for another case. Cases came from a single
prioritized list, and were assigned by the team leader based on FTE's available
and his estimations of hours of work.&lt;/p&gt;
&lt;p&gt;So what exactly was wrong with this approach? Many things, but what I want to
focus on now is that there was no way for anyone to get an insight in the
progress of any individual case, let alone the sprint itself.&lt;/p&gt;
&lt;p&gt;Sure, you could go to an individual case in FogBugz and see how many hours were
registered on it, but that only helps you if you live in a fairy tale world
where an hour registered directly correlates with an hour less work to be done.
You could also of course talk with the engineer working on the case, but as he
didn't make the estimate and because there was no structure for creating tasks,
he often didn't really know what was left to do. As you can imagine, this led to
many issues towards the end of a sprint, with cases not being finished and
no-one knowing what was going on.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="evolution"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;Evolution&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;This approach evolved quite a bit before arriving to our current solution. One
of the improvements was the introduction of the &lt;a class="reference external" href="http://www.fogcreek.com/fogbugz/plugins/plugin.aspx?ixPlugin=15"&gt;Kanban plugin&lt;/a&gt; in FogBugz,
which allowed people to see in which sprint which case would be done. Definitely
an improvement, but not yet enough.&lt;/p&gt;
&lt;p&gt;Another was to simply use wall stickies. While this was nice and tangible, it
also had its downsides. A burndown had to be drawn by hand (what are we,
peasants?), and there was a bit of a barrier (however tiny) to get up, walk over
to the board and create a card if you need one. This caused many fires (and
other work) to be undocumented and as such invisible, which made controlling the
sprint even harder.&lt;/p&gt;
&lt;p&gt;And of course, by using stickies there was no log of past sprints, a huge
downside as well. And it didn't scale. And stickies started falling off the
wall. You get my point.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="enter-trello"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;Enter Trello&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;To quote from their site: "Trello makes it easy to organize anything with
anyone". Luckily for us, it does indeed. We now use it for our sprint boards so
that teams can register their planned work and progress, as well as for our
backlog boards. I'll now go into some more detail on these boards.&lt;/p&gt;
&lt;div class="section" id="sprint-board"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id6"&gt;Sprint board&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;A typical sprint board of one of our teams looks something like this:&lt;/p&gt;
&lt;img alt="Sprint board" class="align-center" src="http://developer.paylogic.com/images/trello/sprint-board.png"/&gt;
&lt;p&gt;Let's go through the columns (or lists in Trello's terminology).&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;strong&gt;User stories&lt;/strong&gt;: The user stories committed for this sprint. Each of these
has a case number, written before its name, and an estimate, written behind it
between brackets. You can read "knots" basically as &lt;a class="reference external" href="https://www.scrumalliance.org/community/articles/2014/january/a-practical-guide-story-points-based-estimation.aspx"&gt;story points&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;User stories - Done in sprint&lt;/strong&gt;: The user stories that fulfill the
Definition of Done, at least for within the sprint. In our case, user stories
often aren't deployed during a sprint, so there's a separate Definition of
Done for that.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;To Do&lt;/strong&gt;: This column contains the &lt;em&gt;tasks&lt;/em&gt; of the user stories that still
have to be done. The tasks are not really linked to user stories (Trello does
not provide such functionality between cards), but by using the same case
number and the same color, we can visually distinguish them quite easily.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Doing&lt;/strong&gt;: These are tasks that are currently in progress.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Done&lt;/strong&gt;: All tasks that are completed will end up here.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Fires&lt;/strong&gt;: All fires encountered in this sprint. We often use a placeholder to
keep a buffer for unexpected work.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Fires Done&lt;/strong&gt;: A fire that was completed will end up here.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;During the sprint planning, each team creates cards for the user stories and the
tasks on the sprint board of that sprint. Everything on the sprint board is part
of the commitment, so this is automatically generated.&lt;/p&gt;
&lt;p&gt;Important to note is that the team itself is in full charge of this board. Not
the team leader, not the SCRUM master, but the team. More complicated or
cumbersome tools are often by necessity managed by a single person, which is
actually a bad thing as the responsibility of owning and administrating the work
(and commitment) is then not correctly distributed. Thanks to Trello being so
accessible and easy to use, it is no problem to have the team be the owner of
this as well.&lt;/p&gt;
&lt;p&gt;After sprint planning, it's simply a matter of starting a task and moving it to
Doing, actually doing the task, and when it's done, moving it to Done and
picking up the next one. When all tasks of a story are done, the user story can
be moved to Done in sprint (after creating a codereview for the Gatekeepers in
FogBugz), and you can start work on another task. Easy as that!&lt;/p&gt;
&lt;p&gt;There are a few other things worth pointing out about the sprint boards:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;People assign themselves to cards as soon as they start work on a story. If a
story isn't started yet, it probably won't have anyone assigned to it (unless
there's a specific specialization involved). This makes it easy to see what is
started and what not.&lt;/li&gt;
&lt;li&gt;Some cards are not related to user stories. These are GTD cases. GTD stands
for Getting Things Done, and are cards needed to get a user story which was
completed in a previous sprint to production. As we have a gatekeeper and
staging workflow that usually happens in the sprint(s) after the feature was
built, it is essential to track this as well.&lt;/li&gt;
&lt;li&gt;Note the small FogBugz logo (the kiwi) on many cards? That's a link to
FogBugz, which is automatically generated by Trello. There's no such thing for
other bug trackers, but it is fairly trivial to make one yourself using
something like &lt;a class="reference external" href="http://www.greasespot.net/"&gt;Greasemonkey&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;It's also an option to create tasks as checklist items on user story cards,
and work on tasks from there. However, we felt like this obscures important
details, which for us goes against the idea of using a tool like Trello. It
might work for you however, so I did want to mention the option.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="backlogs"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id7"&gt;Backlogs&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;We have three engineering teams, so we need three backlogs as well. One such
backlog board can be seen below.&lt;/p&gt;
&lt;img alt="Backlog board" class="align-center" src="http://developer.paylogic.com/images/trello/backlog-board.png"/&gt;
&lt;p&gt;As you can see, it is quite straightforward. There's a Backlog list, containing
the user stories that are up next, and there is a list for each sprint, to be
able to keep an easy overview of what was done in which sprint.&lt;/p&gt;
&lt;p&gt;For epics, we use checklists in Trello to group related stories together. In
that way, the epic can stay on top of the backlog while its individual stories
are selected from the checklist and moved into the sprint. This works well in
the case that you work on a single epic but also want to work on smaller,
unrelated stories and features next to it, as you can then prioritize the entire
functionality (which the epic encompasses) instead of just fragments of it.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="custom-tooling"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;Custom tooling&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The biggest advantage and simultaneous disadvantage of Trello is that it does
just one thing and does it well. This means that if you ever want to do
something else, such as generating a burndown chart, you will have to do it
yourself. So, we did.&lt;/p&gt;
&lt;div class="section" id="burndown"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id9"&gt;Burndown&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Fortunately, Trello has an excellent &lt;a class="reference external" href="https://trello.com/docs/"&gt;REST API&lt;/a&gt;, which makes it quite easy to
get the data needed for a simple burndown. We started off with a &lt;a class="reference external" href="http://echobehind.wordpress.com/2012/06/28/create-your-own-burndown-chart-using-trello-api-and-google-apps-script/"&gt;burndown chart
in Google Docs&lt;/a&gt;, which is a nice and lightweight way to start using Trello for
your sprints. It turned out we needed a bit more flexibility however, so we
developed our own burndown application, which can be seen below.&lt;/p&gt;
&lt;img alt="Custom burndown chart" class="align-center" src="http://developer.paylogic.com/images/trello/burndown.png"/&gt;
&lt;p&gt;To be able to generate a burndown using Trello however, you need a way to set
the size of a task, which we do by convention. Notice how in the sprint board
shown above every task has a number of "k" between brackets, so like (2k)?
That's our convention for setting the size of the task, which is of course
trivially parsed.&lt;/p&gt;
&lt;p&gt;Thanks to the fact that we track everything based on tasks, and because our
tasks are as a rule no larger than 4 knots, our burndown is enormously detailed
and fine-grained, and as such gives you a very realistic view of what the
progress of each team is on every given moment.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fogbugz"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id10"&gt;FogBugz&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Another thing that Trello doesn't have is time tracking. There is a Chrome
extension to allow time tracking in Trello using &lt;a class="reference external" href="https://www.getharvest.com/trello/"&gt;Harvest&lt;/a&gt;, but the thing is we
don't use Harvest; we use Fogbugz. So we developed and open sourced a &lt;a class="reference external" href="https://github.com/paylogic/trello_workon/tree/oop-refactor"&gt;simple
synchronization tool&lt;/a&gt; for that.&lt;/p&gt;
&lt;p&gt;What it does is it periodically looks at the task a member has in the "Doing"
column, finds the case corresponding to that task in FogBugz, and starts
registering hours for that user on that case (using &lt;a class="reference external" href="http://help.fogcreek.com/8202/xml-api"&gt;FogBugz's less than awesome
API&lt;/a&gt;). It's not ideal, but it works for us, and saves our engineers the hassle
of having to do double administration.&lt;/p&gt;
&lt;p&gt;Of course, being resourceful engineers, we integrated this information then
again with our burndown chart, so that we could display what every engineer is
working on right now next to the burndown chart, together with the progress of
the case. Magic!&lt;/p&gt;
&lt;img alt="Displaying of who works on what case" class="align-center" src="http://developer.paylogic.com/images/trello/workon.png"/&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="closing-thoughts"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;Closing thoughts&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;So that's in a nutshell how we use Trello for our sprints. We've been using it
for our sprint boards for nearly two years now, and it definitely has stood the
test of time. We've been using it for other things as well, such as for project
management (for which the &lt;a class="reference external" href="http://help.trello.com/customer/portal/articles/1262881-viewing-cards-in-a-calendar-view"&gt;calendar view&lt;/a&gt; is quite useful), as Kanban board for
our Operational IT team, and for storing code snippets. The fact that there is
Google Apps integration is quite a bonus for us as well (although that is only
part of their paid &lt;a class="reference external" href="https://trello.com/business-class"&gt;business class&lt;/a&gt; subscription).&lt;/p&gt;
&lt;p&gt;Now it has to be mentioned that there are many other tools out there that
attempt to solve all of our problems in a single tool. This would of course be
better, so that we wouldn't have to develop and maintain our custom tooling.
However, I personally haven't found one that I liked as much, and that allowed
the same flexibility, as what we have right now. For example, many tools that I
found don't allow you to generate a burndown based on your tasks, only of your
user stories, which in my opinion is a serious limitation. If you do have a tool
that you can recommend,  please shoot me an email or leave a comment.&lt;/p&gt;
&lt;p&gt;Oh and there is of course a Chrome plugin called &lt;a class="reference external" href="https://chrome.google.com/webstore/detail/scrum-for-trello/jdbcdblgjdpmfninkoogcfpnkjmndgje?hl=en"&gt;Scrum for Trello&lt;/a&gt;. When we
looked at it, it sadly wasn't very mature yet and it didn't fit our needs, but
it does look pretty good now. Someone also pointed out &lt;a class="reference external" href="https://chrome.google.com/webstore/detail/plus-for-trello/gjjpophepkbhejnglcmkdnncmaanojkf/related?hl=en"&gt;Plus for Trello&lt;/a&gt; to me
which I didn't know about before, but it looks promising as well. Give it a go!&lt;/p&gt;
&lt;p&gt;And don't forget to check out the &lt;a class="reference external" href="https://trello.com/taco-game"&gt;taco game&lt;/a&gt;.&lt;/p&gt;
&lt;!-- External references: --&gt;
&lt;/div&gt;
</summary><category term="trello"></category><category term="fogbugz"></category><category term="burndown"></category><category term="scrum"></category><category term="agile"></category></entry><entry><title>Paylogic Code review tool</title><link href="http://developer.paylogic.com/articles/codereview.html" rel="alternate"></link><updated>2014-07-17T09:00:00+02:00</updated><author><name>Anatoly Bubenkov</name></author><id>tag:developer.paylogic.com,2014-07-17:articles/codereview.html</id><summary type="html">
&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id1"&gt;Introduction&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As open sourcing software is a strategic decision of Paylogic we decided not to make an exception for our
development tools, in the hope that they are of use to the community. The code review tool is probably our most
important development tool, so we decided to start with that. The Github repository can be found
&lt;a class="reference external" href="https://github.com/paylogic/codereview"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="http://en.wikipedia.org/wiki/Code_review"&gt;Code review&lt;/a&gt; is one of the main pillars of the Paylogic development
process. We have multiple projects ongoing, and none of the code changes can go into the stable repository
without at least 2 code reviews. The last code review is done by a special company role - &lt;tt class="docutils literal"&gt;Gatekeeper&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;We will reveal more about the gatekeeper process in later articles, but you can already see that code reviewing
is a very important process for us, so the tool we use for it is important as well.&lt;/p&gt;
&lt;p&gt;This article covers and explains the choice of the tool, its customizations, and the use case.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-choice"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id2"&gt;The Choice&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;In 2011 we had to choose a code review tool, and after a thorough research
&lt;a class="reference external" href="https://code.google.com/p/rietveld/"&gt;rietveld&lt;/a&gt; seemed one of the best solutions for our specific needs:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Web based.&lt;/li&gt;
&lt;li&gt;Minimalistic, code centric interface.&lt;/li&gt;
&lt;li&gt;Has keyboard shortcuts for easy code review navigation.&lt;/li&gt;
&lt;li&gt;Written in python, so it's easy to change and maintain.&lt;/li&gt;
&lt;li&gt;Has a community which improves it constantly.&lt;/li&gt;
&lt;li&gt;Simple installation on a private server.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="customizations"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;Customizations&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;So we decided to use rietveld. But we had to customize it significantly as our development process uses
&lt;a class="reference external" href="https://www.fogcreek.com/fogbugz/"&gt;Fogbugz&lt;/a&gt; as a case management tool. This means that every change to the
Paylogic codebase has a reference to a Fogbugz case, and the development itself is case-based.&lt;/p&gt;
&lt;p&gt;The whole picture of our continuous integration will be described in later article(s), however there was a
&lt;a class="reference external" href="http://www.slideshare.net/zittersteyn/advanced-continuous-integration-pygrunn-2014-dirk-zittersteyn"&gt;great talk&lt;/a&gt;
at our &lt;a class="reference external" href="http://pygrunn.org/"&gt;PyGrunn&lt;/a&gt; conference
on this topic from &lt;a class="reference external" href="http://nl.linkedin.com/in/dzittersteyn"&gt;Dirk Zittersteyn&lt;/a&gt;.  However, since it is important
to understand the role the code review tool plays in our ecosystem, the below image shows a part of the process.&lt;/p&gt;
&lt;img alt="gatekeepering and code review process" class="align-center" src="http://developer.paylogic.com/images/codereview/gatekeepering-and-code-review-process.png"/&gt;
&lt;p&gt;As you can see from the diagram (and the Legend), the code review tool is a critical part of our process.&lt;/p&gt;
&lt;p&gt;Before we continue, we'll give you a quick glossary for the rest of this article:&lt;/p&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;&lt;tt class="docutils literal"&gt;original repository&lt;/tt&gt; (&lt;tt class="docutils literal"&gt;target repository&lt;/tt&gt;)&lt;/dt&gt;
&lt;dd&gt;Version control repository which is considered as a target in which to merge some proposed set of changes.&lt;/dd&gt;
&lt;dt&gt;&lt;tt class="docutils literal"&gt;original branch&lt;/tt&gt; (&lt;tt class="docutils literal"&gt;target branch&lt;/tt&gt;)&lt;/dt&gt;
&lt;dd&gt;Version control branch in the &lt;tt class="docutils literal"&gt;original repository&lt;/tt&gt; in which to merge some proposed set of changes.&lt;/dd&gt;
&lt;dt&gt;&lt;tt class="docutils literal"&gt;feature repository&lt;/tt&gt; (&lt;tt class="docutils literal"&gt;source repository&lt;/tt&gt;)&lt;/dt&gt;
&lt;dd&gt;Version control repository which is considered as a source of the proposed set of changes. This can be the same as
&lt;tt class="docutils literal"&gt;original repository&lt;/tt&gt;.&lt;/dd&gt;
&lt;dt&gt;&lt;tt class="docutils literal"&gt;feature branch&lt;/tt&gt; (&lt;tt class="docutils literal"&gt;source branch&lt;/tt&gt;)&lt;/dt&gt;
&lt;dd&gt;Version control branch in the &lt;tt class="docutils literal"&gt;source repository&lt;/tt&gt; which is considered as a source of the proposed
set of changes.&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;With the customizations we've made to &lt;tt class="docutils literal"&gt;rietveld&lt;/tt&gt;, we can now:&lt;/p&gt;
&lt;div class="section" id="use-corporate-single-sign-on-to-authorize-users-in-the-code-review-tool"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id4"&gt;Use corporate single sign-on to authorize users in the code review tool&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;It's important to remove unnecessary additional user management responsibilities from our Operational IT team. And of
course, from the user's perspective it's much less effort, as they can use a single corporate account to log in
(we use &lt;a class="reference external" href="http://www.google.com/enterprise/apps/business/"&gt;Google Apps for Business&lt;/a&gt;)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="create-code-review-issues-patchsets-taking-any-required-information-from-the-corresponding-fogbugz-case"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id5"&gt;Create code review issues (patchsets), taking any required information from the corresponding Fogbugz case&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;This feature is implemented by creating a special endpoint on the code review tool which gets the case number as
a parameter, and retrieves the following fields from that case through the
&lt;a class="reference external" href="http://help.fogcreek.com/8202/xml-api"&gt;Fogbugz API&lt;/a&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Original (target) branch (for example &lt;tt class="docutils literal"&gt;master&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;default&lt;/tt&gt;) - implemented using a custom field in Fogbugz.&lt;/li&gt;
&lt;li&gt;Feature (source) branch (for example &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;nice-feature&lt;/span&gt;&lt;/tt&gt;) - implemented using a custom field in Fogbugz.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For custom fields, we use the &lt;a class="reference external" href="http://www.fogcreek.com/fogbugz/plugins/plugin.aspx?ixPlugin=1"&gt;Custom Fields&lt;/a&gt; plugin.
From the Fogbugz side, it looks like this:&lt;/p&gt;
&lt;img alt="create patchset from Fogbugz" class="align-center" src="http://developer.paylogic.com/images/codereview/create-patchset.png"/&gt;
&lt;/div&gt;
&lt;div class="section" id="apply-custom-validations-for-any-patchsets-created"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id6"&gt;Apply custom validations for any patchsets created&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;We implement some critical checks, where we for example don't allow the changing of certain non-editable files.
If any of the validations didn't pass, creation of the issue (i.e. an additional patchset) fails and shows an error
to the user.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="implement-gatekeepering-process-support"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id7"&gt;Implement Gatekeepering process support&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Users with a special role can now &lt;tt class="docutils literal"&gt;approve&lt;/tt&gt; a certain revision of the feature branch.&lt;/p&gt;
&lt;p&gt;This is, again, implemented using a special custom field in Fogbugz called
&lt;tt class="docutils literal"&gt;approved revision&lt;/tt&gt;, together with the Fogbugz API to set it from the code review tool.&lt;/p&gt;
&lt;p&gt;In the code review tool:&lt;/p&gt;
&lt;img alt="approve revision from codereview by the gatekeeper, target branch autocompletion" class="align-center" src="http://developer.paylogic.com/images/codereview/approve-revision-click.png"/&gt;
&lt;p&gt;And in Fogbugz:&lt;/p&gt;
&lt;img alt="approved revision and ci project fields set in the Fogbugz" class="align-center" src="http://developer.paylogic.com/images/codereview/approved-revision-field.png"/&gt;
&lt;/div&gt;
&lt;div class="section" id="allow-gatekeepers-to-set-and-select-from-the-dropdown-the-target-branch-for-a-given-ci-project"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id8"&gt;Allow gatekeepers to set (and select from the dropdown) the target branch for a given CI project&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Both &lt;tt class="docutils literal"&gt;target branch&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;CI project&lt;/tt&gt; are custom fields of a Fogbugz case.&lt;/p&gt;
&lt;p&gt;In the code review tool:&lt;/p&gt;
&lt;img alt="approve revision from codereview by the gatekeeper, target branch autocompletion" class="align-center" src="http://developer.paylogic.com/images/codereview/approve-revision-target-branch.png"/&gt;
&lt;p&gt;And in Fogbugz:&lt;/p&gt;
&lt;img alt="target branch field in the Fogbugz" class="align-center" src="http://developer.paylogic.com/images/codereview/target-branch-field.png"/&gt;
&lt;/div&gt;
&lt;div class="section" id="support-creation-of-an-issue-patchset-using-bzr-git-and-mercurial-repositories"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id9"&gt;Support creation of an issue (patchset), using bzr, git and mercurial repositories&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;All combinations are accepted for &lt;tt class="docutils literal"&gt;original&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;feature&lt;/tt&gt; branch fields in Fogbugz.
As additional protection from &lt;tt class="docutils literal"&gt;phishing&lt;/tt&gt; on the &lt;tt class="docutils literal"&gt;original&lt;/tt&gt; branch, the latest revision from
the &lt;tt class="docutils literal"&gt;source repository&lt;/tt&gt;'s &lt;tt class="docutils literal"&gt;original branch&lt;/tt&gt; will be used to calculate a diff between
the &lt;tt class="docutils literal"&gt;source repository&lt;/tt&gt;'s &lt;tt class="docutils literal"&gt;feature branch&lt;/tt&gt; and the &lt;tt class="docutils literal"&gt;original repository&lt;/tt&gt;'s &lt;tt class="docutils literal"&gt;original branch&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="problems-using-rietveld"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;Problems using rietveld&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;rietveld was developed specially for &lt;a class="reference external" href="https://developers.google.com/appengine/?csw=1"&gt;Google App Engine&lt;/a&gt;.
It has lots of benefits for developers who don't want to bother with any OpIT related tasks.
As we however have a strict requirement to host the code (and thus the code review tool) on our private servers, we used
&lt;a class="reference external" href="http://django-gae2django.googlecode.com/svn/trunk/examples/rietveld/README"&gt;gae2django&lt;/a&gt; to deploy rietveld locally.
What gae2django does is convert models that are supposed to be used with the
Google App Engine datastore to Django ORM models. This allows us to deploy the
application using relational databases such as (in our case) MySQL.&lt;/p&gt;
&lt;p&gt;This was &lt;tt class="docutils literal"&gt;good enough&lt;/tt&gt; for us, as up till now rietveld was using GAE DB (ext.db). But this is no longer the case.
Now rietveld uses &lt;a class="reference external" href="https://developers.google.com/appengine/docs/python/ndb/"&gt;NDB&lt;/a&gt; for its models. And it's simply
&lt;tt class="docutils literal"&gt;not possible&lt;/tt&gt; to implement automatic mapping from NDB-based models to django ORM models
because the difference is huge.&lt;/p&gt;
&lt;p&gt;So currently, we are in the situation that we cannot receive any updates from the rietveld repository any more,
so instead we have to support our &lt;tt class="docutils literal"&gt;fork&lt;/tt&gt; ourselves. For now this is &lt;tt class="docutils literal"&gt;acceptable&lt;/tt&gt;,
but we are considering moving to a different code review tool.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="want-to-use-it-or-to-try-it"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;Want to use it or to try it?&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The &lt;a class="reference external" href="https://github.com/paylogic/codereview/blob/master/README.rst"&gt;readme&lt;/a&gt; on Github contains all the information
required to set up the code review tool on your server. Don't hesitate to try it out.
If you have any problems with installation, please create an &lt;a class="reference external" href="https://github.com/paylogic/codereview/issues/"&gt;issue&lt;/a&gt;
on Github.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="future-considerations"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id12"&gt;Future considerations&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As was mentioned earlier, &lt;tt class="docutils literal"&gt;Review Board&lt;/tt&gt; will probably be the replacement for
our current solution. However, if we'll switch to git completely (which we haven't done yet) there are
some other alternatives to consider as well, such as:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.gitlab.com/"&gt;GitLab&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://code.google.com/p/gerrit/"&gt;Gerrit&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Any new tool we might choose will have to be customized in order to be an integral part of our development process.
This new customization will be open sourced as well.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="thanks-questions"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id13"&gt;"Thanks! Questions?"&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;So regarding the code review, we've put all our cards on the table: from decision making to implementation,
support, and use cases. We hope that it will be useful for the community.
Feedback is, as usual, more than appreciated. Happy code reviewing, we wish you 0 comments on your reviews!&lt;/p&gt;
&lt;/div&gt;
</summary><category term="code review"></category><category term="gatekeeper"></category><category term="fogbugz"></category><category term="review"></category><category term="rietveld"></category><category term="open source"></category></entry><entry><title>pytest-xdist and session-scoped fixtures</title><link href="http://developer.paylogic.com/articles/pytest-xdist-and-session-scoped-fixtures.html" rel="alternate"></link><updated>2014-05-28T12:36:00+02:00</updated><author><name>Anatoly Bubenkov</name></author><id>tag:developer.paylogic.com,2014-05-28:articles/pytest-xdist-and-session-scoped-fixtures.html</id><summary type="html">
&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id2"&gt;Introduction&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;In the earlier &lt;a class="reference external" href="test-p14n"&gt;article on Test parallelization&lt;/a&gt; we unveiled how we &lt;tt class="docutils literal"&gt;parallelize&lt;/tt&gt; our tests.
There we gave a few examples of services we run for the tests. However, due to implementation details of
&lt;a class="reference external" href="https://pytest.org"&gt;pytest&lt;/a&gt; and &lt;a class="reference external" href="https://pytest.org/latest/xdist.html"&gt;pytest-xdist&lt;/a&gt;, it is not possible
to implement service starting and stopping efficiently out of the box. That's why we developed our own solution,
described in this article.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="back-to-the-example-where-the-problem-starts"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;Back to the example, where the problem starts&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;execnet&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;app_worker&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Start web application.&lt;/span&gt;

&lt;span class="sd"&gt;    :param channel: execnet channel to talk to the master process.&lt;/span&gt;
&lt;span class="sd"&gt;    :param str database_connection: the database connection string.&lt;/span&gt;
&lt;span class="sd"&gt;    :param port: the port number that will be used by runserver.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="c"&gt;# monkey patch the database connection&lt;/span&gt;
    &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;config&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;database&lt;/span&gt;
    &lt;span class="n"&gt;database&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;

    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.httpserver&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.ioloop&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.web&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.wsgi&lt;/span&gt;

    &lt;span class="n"&gt;wsgi_app&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wsgi&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WSGIContainer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;app_wsgi_handler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;tornado_app&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;web&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;r"/media/(.*)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;web&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StaticFileHandler&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;"path"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;media_path&lt;/span&gt;&lt;span class="p"&gt;}),&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'.*'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;web&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FallbackHandler&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fallback&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;wsgi_app&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
    &lt;span class="p"&gt;])&lt;/span&gt;

    &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;httpserver&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;HTTPServer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tornado_app&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'started app on port: {0}'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ioloop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IOLoop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;


&lt;span class="nd"&gt;@pytest.fixture&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scope&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'session'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;application&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Start application in a separate process.&lt;/span&gt;

&lt;span class="sd"&gt;    :param port: a random port the application should listen to.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="c"&gt;# create execnet gateway&lt;/span&gt;
    &lt;span class="n"&gt;gw&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;execnet&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;makegateway&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="c"&gt;# set the same python system path on remote python as on current one&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
    &lt;span class="n"&gt;gw&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remote_exec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="p"&gt;[&lt;/span&gt;
            &lt;span class="s"&gt;"import sys"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;"sys.path = {0}"&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;waitclose&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="c"&gt;# create channel running worker function&lt;/span&gt;
    &lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gw&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remote_exec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;app_worker&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;addfinalizer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gw&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;gw&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;What is extremely important here is that we instantiate things like applications and services
only once per test run, because it takes a lot of time to start / stop applications and/or services,
to create databases, etc.&lt;/p&gt;
&lt;p&gt;According to &lt;a class="reference external" href="https://pytest.org/latest/fixture.html"&gt;pytest fixtures&lt;/a&gt;, our application will be instantiated
on demand and should live during the whole test session time. Which is fine, as long as you do
not &lt;tt class="docutils literal"&gt;parallelize&lt;/tt&gt; tests, and therefore do not use &lt;a class="reference external" href="https://pytest.org/latest/xdist.html"&gt;pytest-xdist&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;But when you do use it, it's &lt;strong&gt;not guaranteed&lt;/strong&gt; that test nodes will have only one test session!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pytest-xdist-internals"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;pytest-xdist internals&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;To simplify things, let's concentrate on the &lt;tt class="docutils literal"&gt;stages&lt;/tt&gt; that &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;pytest-xdist&lt;/span&gt;&lt;/tt&gt; uses to run tests in a distributed way:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;Collect all nodes checking the connection&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Rsync files needed&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Collect all tests on every node&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Start 'initial distribution' test sessions over nodes using the number of tests calculated by the following formula:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class="formula"&gt;
&lt;i&gt;ntests&lt;/i&gt; = &lt;i&gt;Ntests&lt;/i&gt; ⁄ (&lt;i&gt;Knodes&lt;/i&gt;*4)
&lt;/div&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;where:&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;ntests - number of tests to run for test node session&lt;/li&gt;
&lt;li&gt;Ntests - total number of tests&lt;/li&gt;
&lt;li&gt;Knodes - number of test nodes&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Start more test sessions for nodes which are done with initial test sessions using the same formula&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;We see here that the more tests you have for the same amount of nodes, the more test sessions will be started!&lt;/p&gt;
&lt;p&gt;In the below diagram we can see how it works in a more visual way:&lt;/p&gt;
&lt;img alt="pytest-xdist in action" class="align-center" src="http://developer.paylogic.com/images/pytest-xdist-in-action.png" style="width: 75%;"/&gt;
&lt;/div&gt;
&lt;div class="section" id="how-to-avoid-multiple-sessions-on-single-node"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;How to avoid multiple sessions on single node&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;So we know that it's possible to get not one but several sessions during the test run on a single node.
How can we avoid that? Fortunately, even though we have multiple sessions per node, it's still the same python process,
so we can cache objects on module level. In this way we &lt;em&gt;invent&lt;/em&gt; a new fixture scope - &lt;tt class="docutils literal"&gt;test run&lt;/tt&gt;.
For fixtures within this scope, the fixture and its finalizer will be called only once per whole test run on a given test node.
Here is the implementation of the utility decorator that we use:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;decorator&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pytest&lt;/span&gt;

&lt;span class="n"&gt;marker&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_memoize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kw&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Memoization helper to cache function's return value as an attribute of this function."""&lt;/span&gt;
    &lt;span class="n"&gt;cache&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;getattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'_cache'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;marker&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;cache&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="n"&gt;marker&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_cache&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kw&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_cache&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;cache&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;memoize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Decorator which caches the return value of the function."""&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;decorator&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;decorator&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_memoize&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you can see it's a pretty straightforward application of the &lt;a class="reference external" href="http://en.wikipedia.org/wiki/Memoization"&gt;memoization
technique&lt;/a&gt; using function object as
a cache storage based on the &lt;a class="reference external" href="https://pypi.python.org/pypi/decorator/3.4.0"&gt;decorator&lt;/a&gt; package.
The &lt;tt class="docutils literal"&gt;decorator&lt;/tt&gt; package is needed to preserve the function
prototype which is important for the &lt;tt class="docutils literal"&gt;pytest fixture dependency injection mechanism&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;So now our application fixture looks like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;atexit&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;execnet&lt;/span&gt;

&lt;span class="nd"&gt;@pytest.fixture&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scope&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'session'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="nd"&gt;@memoize&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;application&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Start application in a separate process.&lt;/span&gt;

&lt;span class="sd"&gt;    :param port: a random port the application should listen to.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="c"&gt;# create execnet gateway&lt;/span&gt;
    &lt;span class="n"&gt;gw&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;execnet&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;makegateway&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="c"&gt;# set the same python system path on remote python as on current one&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
    &lt;span class="n"&gt;gw&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remote_exec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="p"&gt;[&lt;/span&gt;
            &lt;span class="s"&gt;"import sys"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;"sys.path = {0}"&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;waitclose&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="c"&gt;# create channel running worker function&lt;/span&gt;
    &lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gw&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remote_exec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;app_worker&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;atexit&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;register&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gw&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;gw&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By using the &lt;tt class="docutils literal"&gt;memoize&lt;/tt&gt; decorator we avoid calling the &lt;tt class="docutils literal"&gt;application&lt;/tt&gt; function multiple times during the test run, even if
there will be multiple sessions involved on a single test node.
The result of the first call of the &lt;tt class="docutils literal"&gt;application&lt;/tt&gt; function will be cached as an attribute on the application function.
Subsequent calls will just return the cached value.
Note that instead of &lt;tt class="docutils literal"&gt;request.addfinalizer&lt;/tt&gt; we use &lt;tt class="docutils literal"&gt;atexit.register&lt;/tt&gt;. This is because memoization has it's downside - we cannot use
pytest's normal fixture finalizers simply because there's no scope higher than &lt;tt class="docutils literal"&gt;session&lt;/tt&gt; at the moment.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;We identified a few advantages of using the approach discussed in the previous sections.
This approach allowed us to considerably reduce our test execution time.
It also improved the test stability, because the OS performs better as it doesn't need to spawn and kill lots
of processes. We hope that you will find our approach useful, especially if you use &lt;tt class="docutils literal"&gt;pytest&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;pytest-xdist&lt;/span&gt;&lt;/tt&gt;,
as you will probably run into the same issues as we did.&lt;/p&gt;
&lt;/div&gt;
</summary><category term="testing"></category><category term="pytest"></category><category term="pytest-xdist"></category><category term="fixtures"></category><category term="session"></category></entry><entry><title>Settei</title><link href="http://developer.paylogic.com/articles/settei.html" rel="alternate"></link><updated>2014-04-29T12:03:00+02:00</updated><author><name>Spyros Ioakeimidis</name></author><id>tag:developer.paylogic.com,2014-04-29:articles/settei.html</id><summary type="html">
&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;Introduction&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;settei&lt;/code&gt; is a general purpose python settings library which uses
&lt;a class="reference external" href="http://pythonhosted.org/setuptools/pkg_resources.html#entry-points"&gt;entry points&lt;/a&gt;
as a registry, inspired by &lt;a class="reference external" href="http://pythonhosted.org/setuptools/setuptools.html"&gt;setuptools&lt;/a&gt;.
It is a library which provides the possibility to define
and use configuration settings from entry points for specific applications and
environments. &lt;code&gt;settei&lt;/code&gt; introduces the following terms:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;strong&gt;environment&lt;/strong&gt;: the name of an entry point&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;group&lt;/strong&gt;: a group of defined environments&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;application&lt;/strong&gt;: part of a group's name and refers to the application to which
settings apply&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A minimal app that illustrates the use of &lt;cite&gt;settei&lt;/cite&gt; can be found
&lt;a class="reference external" href="https://github.com/paylogic/settei-example"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="motivation"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;Motivation&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;At Paylogic we are extensively using &lt;a class="reference external" href="https://www.djangoproject.com/"&gt;Django&lt;/a&gt;
web framework for most parts of our system. Django uses the concept of
&lt;a class="reference external" href="https://docs.djangoproject.com/en/1.6/topics/settings/"&gt;setting files&lt;/a&gt;, in
which we can define application-specific settings, such as &lt;tt class="docutils literal"&gt;DEBUG&lt;/tt&gt;. In the
rest of the application we can access these settings using for example
&lt;code&gt;django.conf.settings.DEBUG&lt;/code&gt;. However, for other parts of our system we
are using &lt;a class="reference external" href="http://flask.pocoo.org/"&gt;Flask&lt;/a&gt;, which follows a similar, but
slightly different way to define &lt;a class="reference external" href="http://flask.pocoo.org/docs/config/"&gt;configuration settings&lt;/a&gt;. In a Flask application a setting can
be accessed by for example &lt;code&gt;app.config['DEBUG']&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Soon we were confronted with the limitation to share configuration settings
between Flask and Django applications. Additionally, we wanted to keep these
configurations consistent. However, we found out that there was no
framework-agnostic Python library for specifying configuration settings.&lt;/p&gt;
&lt;p&gt;Moreover, as we have a clear separation between environments (e.g. dev, staging,
live etc.), some configuration settings are either set in one environment and
not in the others, or the same configuration settings have different values
depending on the environment. The code however should not know anything about
the environment in which it is executed. In this way the code does not need to
be modified, even when multiple environments are used.&lt;/p&gt;
&lt;p&gt;For this reason, we initially decided to create separate files to store
configuration settings, which could also change depending on the environment.
However, we ended up with many of these files, which at some point became
cumbersome to maintain.  Furthermore, some developers started importing settings
from these files and others used the standard way of Django. The result of this
is inconsistencies and conflicts, as the same setting can be imported from
different places.&lt;/p&gt;
&lt;div class="section" id="requirements"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id5"&gt;Requirements&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Based on this motivation, we came up with a number of requirements for a settings
configuration system.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Introducing a new environment should be easy and without too much hassle.&lt;/li&gt;
&lt;li&gt;We should have the possibility to inherit/extend settings from other
environments.  This would allow us to build a modular and extensible structure
of configuration settings.&lt;/li&gt;
&lt;li&gt;There should be no specific template structure involved for generating
settings, because it gets really hard and cumbersome to read templates with
tons of expressions.&lt;/li&gt;
&lt;li&gt;It should be possible to store settings separately from applications and
scripts. The advantage of this is that we can create secret settings (usually
for the production environment) in a way that also makes them safe and that
does not depend on a specific application.&lt;/li&gt;
&lt;li&gt;A configuration settings system should be framework-agnostic so that it can be used
when multiple frameworks are involved.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="design"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;Design&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The most important design decision of &lt;code&gt;settei&lt;/code&gt; is to base its implementation
on the concept of &lt;a class="reference external" href="http://pythonhosted.org/setuptools/pkg_resources.html#entry-points"&gt;entry points&lt;/a&gt;
in order to create a framework-agnostic library for configuration settings.&lt;/p&gt;
&lt;div class="section" id="id2"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id7"&gt;Entry points&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Entry points provide an intuitive way for distributions to expose Python objects,
such as functions or classes, so that they can be used by other distributions.
Applications can then search for specific entry points. &lt;code&gt;settei&lt;/code&gt; uses the
concept of entry points to define groups of environments.&lt;/p&gt;
&lt;p&gt;So, what does using entry points mean? It means that we will have the possibility
to store settings in a distribution. Then, if we want to get access to settings of
e.g. a default or a local environment, we will need to have access to install this
distribution and include this distribution in the &lt;tt class="docutils literal"&gt;PYTHONPATH&lt;/tt&gt; of the script
or application.&lt;/p&gt;
&lt;div class="section" id="groups-and-environments"&gt;
&lt;h4&gt;Groups and environments&lt;/h4&gt;
&lt;p&gt;A group is a container of environments. An example of a group with two environments
could be:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;setup&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
    &lt;span class="n"&gt;entry_points&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="s"&gt;'settings_application_name'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
            &lt;span class="s"&gt;'default = path.to.package.of.application_name.default_settings:generate_config'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;'local = path.to.package.of.application_name.local_settings:generate_config'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="p"&gt;],&lt;/span&gt;
        &lt;span class="c"&gt;# ...&lt;/span&gt;
    &lt;span class="p"&gt;},&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The name of the group consists of two parts. The first is a standard prefix
part, &lt;code&gt;settings_&lt;/code&gt;, and the second is the name of the application. For
example, &lt;code&gt;settings_application_name&lt;/code&gt;, where &lt;code&gt;application_name&lt;/code&gt; is
the name of the application. The prefix part in the group name is mandatory as
it helps &lt;code&gt;settei&lt;/code&gt; to identify only entry points useful for it and iterate
through them.&lt;/p&gt;
&lt;p&gt;Each environment name inside a group must be &lt;tt class="docutils literal"&gt;unique&lt;/tt&gt;. In our example, in the
group &lt;code&gt;settings_application_name&lt;/code&gt; there should only be one environment named
&lt;code&gt;default&lt;/code&gt; and only one named &lt;code&gt;local&lt;/code&gt;. However, we can specify same
environment names that belong to different groups. If we specify environments
with the same name inside one group, then a &lt;code&gt;DuplicateEntryPoint&lt;/code&gt; exception
will be raised. This exception is used to avoid cases of scripts borrowing
settings from each other. For example, lets assume that in the previous example
we specified the &lt;tt class="docutils literal"&gt;default&lt;/tt&gt; environemnt twice. It would not be clear from which
file (default_settings.py or local_settings.py) we would read settings.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="example-usage"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;Example Usage&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The &lt;code&gt;settei&lt;/code&gt; package can be configured and used in a series of simple steps.&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Define groups and environments in the &lt;tt class="docutils literal"&gt;setup.py&lt;/tt&gt; of the package.&lt;/li&gt;
&lt;li&gt;For each environment (e.g. default_settings), define the function to be used
as an entry point.&lt;/li&gt;
&lt;li&gt;Implement this function in the environment files (e.g. default_settings.py).
They should create and return a new instance of &lt;code&gt;Config&lt;/code&gt; with
configuration settings for this environment.&lt;/li&gt;
&lt;li&gt;Use the &lt;code&gt;get_config&lt;/code&gt; function in the rest of the package to read
configuration settings for specific applications and environments.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The best way to explain how &lt;code&gt;settei&lt;/code&gt; can be used is through examples.
The rest of this section goes into more detail for each of the above steps.&lt;/p&gt;
&lt;div class="section" id="define-groups-and-environments"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id9"&gt;Define groups and environments&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;As a first step, we need to define environments and put them into groups. We are
free to choose the name of the function to be used as an entry point. In this case,
we chose the name &lt;code&gt;generate_config&lt;/code&gt;. Let's assume that our package contains
two applications.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# package/setup.py&lt;/span&gt;
&lt;span class="n"&gt;setup&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
    &lt;span class="n"&gt;entry_points&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="s"&gt;'settings_application1'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
            &lt;span class="s"&gt;'default = path.to.application1.default_settings:generate_config'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;'local = path.to.application1.local_settings:generate_config'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="p"&gt;],&lt;/span&gt;
        &lt;span class="s"&gt;'settings_application2'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
            &lt;span class="s"&gt;'default = path.to.application2.default_settings:generate_config'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;'local = path.to.application2.local_settings:generate_config'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="p"&gt;],&lt;/span&gt;
    &lt;span class="p"&gt;},&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="create-settings"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id10"&gt;Create settings&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;To create settings, we need an instance of the &lt;code&gt;Config&lt;/code&gt; class.
In the following example, we are using the function named &lt;code&gt;generate_config&lt;/code&gt;,
which we specified as an entry point when we defined the groups and environments.
The &lt;code&gt;generate_config&lt;/code&gt; function, in our case, returns an instance of the
&lt;code&gt;Config&lt;/code&gt; class. Settings can then be created either directly in the code,
be loaded from a python file, or come from an object. If there is any error
during configuration or a &lt;code&gt;Config&lt;/code&gt; instance is not returned, then a
&lt;code&gt;WrongConfigTypeError&lt;/code&gt; exception is raised.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# package/application1/default_settings.py&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;settei.config&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Config&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;generate_config&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="n"&gt;config&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Config&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="c"&gt;# create settings directly&lt;/span&gt;
    &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'QUESTION'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;'The Ultimate Question of Life, the Universe, and Everything'&lt;/span&gt;
    &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'ANSWER'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;41&lt;/span&gt;

    &lt;span class="c"&gt;# or load them from a file&lt;/span&gt;
    &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_pyfile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'full/path/to/file.py'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="c"&gt;# or from an object&lt;/span&gt;
    &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_object&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'path.to.object'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="read-settings"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id11"&gt;Read settings&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;In order to use the settings of our package, we need to first install it using
&lt;code&gt;python setup.py install&lt;/code&gt; and make sure that it is in our path. We can then
read and use settings in the rest of our package
by using the &lt;code&gt;get_config&lt;/code&gt; function. Note that in the &lt;code&gt;get_config&lt;/code&gt;
function we specify the application name and not the group name. For example,
if we want to load settings for the application &lt;code&gt;application1&lt;/code&gt; and we have
defined a group of environments with the name &lt;code&gt;settings_application1&lt;/code&gt;,
then in the &lt;code&gt;get_config&lt;/code&gt; function we just use the name of the application,
which in this case is &lt;code&gt;application1&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;settei&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;get_config&lt;/span&gt;

&lt;span class="c"&gt;# get config settings for 'applicaion1' application and 'local' environment&lt;/span&gt;
&lt;span class="n"&gt;config&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'application1'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'local'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c"&gt;# get config settings for 'application2' application and 'local' environment&lt;/span&gt;
&lt;span class="n"&gt;config&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'application2'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'local'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c"&gt;# now you can use it as you want&lt;/span&gt;
&lt;span class="n"&gt;DEBUG&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'DEBUG'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If the environment from which we want to read settings does not exist, then an
&lt;code&gt;EnvironmentNotSpecified&lt;/code&gt; exception is raised.&lt;/p&gt;
&lt;p&gt;Another way to define the desired environment is using the
&lt;code&gt;CONFIG_ENVIRONMENT&lt;/code&gt; environment variable.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# run in this way&lt;/span&gt;
&lt;span class="err"&gt;$&lt;/span&gt; &lt;span class="n"&gt;env&lt;/span&gt; &lt;span class="n"&gt;CONFIG_ENVIRONMENT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'dev'&lt;/span&gt; &lt;span class="n"&gt;python&lt;/span&gt; &lt;span class="n"&gt;my_incredible_script&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then, in &lt;tt class="docutils literal"&gt;my_incredible_script.py&lt;/tt&gt; when the &lt;code&gt;get_config&lt;/code&gt; function is
used, we do not need to specify an environment as it will use the &lt;code&gt;dev&lt;/code&gt;
environment that is defined by &lt;code&gt;CONFIG_ENVIRONMENT&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# and in my_incredible_script.py we can use get_config&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;settei&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;get_config&lt;/span&gt;

&lt;span class="c"&gt;# get config settings for 'application1' application and 'dev' environment,&lt;/span&gt;
&lt;span class="c"&gt;# which has been specified when running my_incredible_script.py&lt;/span&gt;
&lt;span class="n"&gt;config&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'application1'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="settings-inheritance"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id12"&gt;Settings inheritance&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Settings can also inherit other settings. However, this is only possible
for settings that belong to the same group of environments. For instance, if
you want your &lt;code&gt;local&lt;/code&gt; settings to inherit the &lt;code&gt;default&lt;/code&gt; settings,
then in the &lt;code&gt;generate_config&lt;/code&gt; function you should mention the name of
environment from which you want to inherit.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# in your application1/local_settings.py file&lt;/span&gt;
&lt;span class="c"&gt;# 'default' is the environment from which we want to inherit settings&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;generate_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;default&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="c"&gt;# change a setting, the right answer is 42&lt;/span&gt;
    &lt;span class="n"&gt;default&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'ANSWER'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;42&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;default&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If we read the &lt;code&gt;local&lt;/code&gt; settings, then we will see that
&lt;code&gt;config['ANSWER']&lt;/code&gt; setting returns the value defined in
&lt;code&gt;local_settings.py&lt;/code&gt;, as we would expect.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;settei&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;get_config&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'application1'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;'local'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'QUESTION'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;The&lt;/span&gt; &lt;span class="n"&gt;Ultimate&lt;/span&gt; &lt;span class="n"&gt;Question&lt;/span&gt; &lt;span class="n"&gt;of&lt;/span&gt; &lt;span class="n"&gt;Life&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;Universe&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="n"&gt;Everything&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'ANSWER'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="mi"&gt;42&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Inheriting other settings does not stop us from introducing additional ones.
Attention should be paid though as new settings could be overwritten by any
inherited ones with the same name.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# in your package/application1/local_settings.py file&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;settei.config&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Config&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;generate_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;default&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;local&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Config&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="c"&gt;# change a setting, the right answer is 42&lt;/span&gt;
    &lt;span class="n"&gt;default&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'ANSWER'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;42&lt;/span&gt;

    &lt;span class="c"&gt;# introduce an additional setting&lt;/span&gt;
    &lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'NEW'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;'A new setting'&lt;/span&gt;

    &lt;span class="c"&gt;# this will be overwritten with the 'ANSWER' from the 'default' environment&lt;/span&gt;
    &lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'ANSWER'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;43&lt;/span&gt;

    &lt;span class="c"&gt;# update the 'local' settings with the 'default' settings&lt;/span&gt;
    &lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;default&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="c"&gt;# local['ANSWER'] will be 42 here again&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;local&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If the provided environment in &lt;code&gt;generate_config&lt;/code&gt; is missing or not
specified, then an &lt;code&gt;EnvironmentIsMissing&lt;/code&gt; or &lt;code&gt;EnvironmentNotSpecified&lt;/code&gt;
exception will be raised respectively. If we try to specify more than one
environment to inherit settings from, then a &lt;code&gt;MoreThanOneDependencyInjection&lt;/code&gt;
exception will be raised.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id13"&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;settei&lt;/code&gt; is a package, which bases its implementation on the concept of
entry points from setuptools, to provide a maintainable way of creating configuration
settings. &lt;code&gt;settei&lt;/code&gt; makes it very easy and intuitive to introduce a new environment,
e.g. a live environment, where settings usually differ a lot from those used
during development. Finally, settings inheritance, which is accomplished by using
dependency injection, provides the modularity and extensibility we needed.&lt;/p&gt;
&lt;/div&gt;
</summary><category term="open source"></category><category term="python"></category><category term="settings"></category><category term="entry points"></category><category term="setuptools"></category></entry><entry><title>Test parallelization</title><link href="http://developer.paylogic.com/articles/test-p14n.html" rel="alternate"></link><updated>2014-01-31T10:37:00+01:00</updated><author><name>Anatoly Bubenkov</name></author><id>tag:developer.paylogic.com,2014-01-31:articles/test-p14n.html</id><summary type="html">
&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id1"&gt;Introduction&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Automated tests are awesome. A good test suite makes refactoring easier and allows
developers to catch bugs before the code is deployed on live or is spotted
by a tester.&lt;/p&gt;
&lt;p&gt;Once the advantages of automated testing are discovered, the number of tests increases
exponentially. At Paylogic, there were about 200 tests in the early testing stage.
The tests took about 5 minutes to run. At the moment, we have about 2500 tests and using
a single test process it takes 1 hour and 40 minutes to execute.&lt;/p&gt;
&lt;p&gt;For developers, it's simply not an option to wait for 2 hours until the whole test suite finishes,
as they want results as soon as possible. They might then take the risk
to push the code untested. However, as we have continuous integration in place, if there are any failing
tests, the developers will get their work back to fix them anyway. This is something that
costs extra time.&lt;/p&gt;
&lt;p&gt;It became clear that something had to be changed. We could completely rewrite the tests, make
them very focused and try mock most of the things (such as the database). However,
this means that the team would have to exclusively dedicate a few months to improve the tests and
stop developing new features.&lt;/p&gt;
&lt;p&gt;Another solution would involve test distribution over several executors that
might run on one or several machines. The same tests run in parallel on
many nodes reduces &lt;a class="reference external" href="http://en.wikipedia.org/wiki/Wall-clock_time"&gt;wall time&lt;/a&gt;.
Everybody is happy: developers do not need to wait hours to get their test
results and get an excuse to go for a coffee.  Product managers do not need to
change the long term planning. Customers are happy.  Profit.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="a-closer-look-to-the-test-suite"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id2"&gt;A closer look to the test suite&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The testing tool we use is &lt;a class="reference external" href="http://pytest.org/"&gt;py.test&lt;/a&gt;. We keep our tests in
a separate folder called tests, which is organized like this:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
tests
├── conftest.py
├── deployment
├── fixtures
├── functional
├── __init__.py
└── unit
&lt;/pre&gt;
&lt;p&gt;In &lt;tt class="docutils literal"&gt;conftest.py&lt;/tt&gt; we store the &lt;tt class="docutils literal"&gt;py.test&lt;/tt&gt; configuration and import fixtures which are
defined in the &lt;cite&gt;fixtures&lt;/cite&gt; folder. The folder &lt;cite&gt;functional&lt;/cite&gt; contains functional tests, &lt;cite&gt;unit&lt;/cite&gt;
contains unit tests and so on.&lt;/p&gt;
&lt;p&gt;The tests require the database to be available, as well as memcache. Functional tests
also expect the &lt;tt class="docutils literal"&gt;web servers&lt;/tt&gt; required for the tests to listen on specific ports. By &lt;tt class="docutils literal"&gt;web servers&lt;/tt&gt; I
mean those servers that serve applications whose code we cover with our tests. Among them can be
the &lt;a class="reference external" href="https://www.djangoproject.com/"&gt;Django&lt;/a&gt; development server, the
&lt;a class="reference external" href="http://flask.pocoo.org/"&gt;Flask&lt;/a&gt; development server, &lt;a class="reference external" href="http://pythonpaste.org/modules/httpserver.html"&gt;paste&lt;/a&gt;
http server and so on.&lt;/p&gt;
&lt;p&gt;A typical development session looks like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;virtualenv env  &lt;span class="c"&gt;# Create a virtualenv.&lt;/span&gt;
&lt;span class="nb"&gt;source &lt;/span&gt;env/bin/activate  &lt;span class="c"&gt;# Activate it.&lt;/span&gt;
pip install -r requirements-testing.txt  &lt;span class="c"&gt;# Install all the needed packages.&lt;/span&gt;
&amp;lt;generate settings &lt;span class="nb"&gt;command&lt;/span&gt;&amp;gt;  &lt;span class="c"&gt;# Generate settings (set up the database connection string etc).&lt;/span&gt;
&amp;lt;database schema generation &lt;span class="nb"&gt;command&lt;/span&gt;&amp;gt; &lt;span class="c"&gt;# Generate the database schema and insert initial data into it.&lt;/span&gt;

&lt;span class="c"&gt;# Implement changes for given feature.&lt;/span&gt;

&lt;span class="c"&gt;# Start web application(s)&lt;/span&gt;

py.test tests  &lt;span class="c"&gt;# Run the tests.&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Dependency satisfaction, configuration, database instantiation and population
together with the startup of the required web application(s) is done outside of the test run.
This makes sense, because none of them has to be done before every test run.
Clearly, a developer has to install a package when a new dependency is
introduced and regenerate settings if a new configuration parameter is added.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="test-parallelization-in-theory-and-practice"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;Test parallelization in theory and practice&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If we run tests in parallel, for example in two sessions, each session will share the same
settings (most importantly the database connection string) and the same web
applications. This has several limitations. If we have two tests that access
the same application simultaneously, their requests will be processed by only one
application worker, which of course leads to a performance decrease.&lt;/p&gt;
&lt;p&gt;Another more serious limitation comes from the way our tests are written. There
are for example tests for ticket generation that check PDF generation. On a high level the tests
look like this:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Create an order.&lt;/li&gt;
&lt;li&gt;Execute the ticket generation function.&lt;/li&gt;
&lt;li&gt;Check that 1 ticket was generated.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The trick is in the second step. The ticket generation function is triggered by
a periodical job. It selects from the database all the orders for which tickets have
to be generated and generates them. In a sequential test run this is not a big
deal because there will never be a situation that one call to the ticket
generation function generates more than one ticket. The performed actions are:&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="16%"&gt;&lt;/col&gt;
&lt;col width="84%"&gt;&lt;/col&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;&lt;strong&gt;Time&lt;/strong&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;strong&gt;Action&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td colspan="2"&gt;Test 1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;Create an order.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;Execute the ticket generation function.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;Check that 1 ticket was generated.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td colspan="2"&gt;Test 2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;Create another order.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;Execute the ticket generation function.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;6&lt;/td&gt;
&lt;td&gt;Check that 1 ticket was generated.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;In a parallel run however, two orders may be generated simultaneously. Then, the
generation function will get both orders, and consequently generate tickets for both.
Imagine situations like this:&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="5%"&gt;&lt;/col&gt;
&lt;col width="47%"&gt;&lt;/col&gt;
&lt;col width="47%"&gt;&lt;/col&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;&lt;strong&gt;Time&lt;/strong&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;strong&gt;Action&lt;/strong&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;strong&gt;Action&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td colspan="2"&gt;Test 1&lt;/td&gt;
&lt;td&gt;Test 2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;Create an order.&lt;/td&gt;
&lt;td rowspan="2"&gt;Create another order.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;Execute the ticket generation function. (Generates 2 tickets.)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;Check that 1 ticket was generated. (Fails! 2 tickets were generated.)&lt;/td&gt;
&lt;td&gt;Execute the ticket generation. (Does nothing!)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;4&lt;/td&gt;
&lt;td&gt; &lt;/td&gt;
&lt;td&gt;Check that 1 ticket was generated. (Fails! 0 tickets were generated.)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Because tests are not always meant to be run in parallel when they are written,
situations like this can happen quite often.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-art-of-mocking"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;The art of mocking&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The simplest way to avoid situations where tests influence each other is to get
rid of the shared resources. In our case, this means that each test session would have its own
unique database connection string, which leads to a non-shared database.&lt;/p&gt;
&lt;p&gt;The problem is that we, using a common-use approach, store settings in python modules and instantiate them from
templates before the test run! An example of configuration using python modules can be found in
&lt;a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/settings"&gt;Django settings&lt;/a&gt;,
&lt;a class="reference external" href="http://flask.pocoo.org/docs/api/#flask.Config.from_object"&gt;Flask configuration&lt;/a&gt;, etc.&lt;/p&gt;
&lt;p&gt;We could checkout the sources of Paylogic to two folders and change the settings
to the ones we want. This would entail some crazy text file editing scripts to
alter settings. In addition, it is not the way &lt;a class="reference external" href="https://pypi.python.org/pypi/pytest-xdist"&gt;pytest-xdist&lt;/a&gt; works.&lt;/p&gt;
&lt;p&gt;Another way is to mock the connection string using a fixture:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nd"&gt;@pytest.fixture&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scope&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'session'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;database_settings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Mock the database settings.&lt;/span&gt;

&lt;span class="sd"&gt;    :param str database_connection: the database connection string.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="c"&gt;# Reset the connection string.&lt;/span&gt;
    &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;config&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;database&lt;/span&gt;
    &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To make the mock successful, our code should behave accordingly. Instead of:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;config.database&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connect_to_db&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;"""Connect to the database,&lt;/span&gt;

&lt;span class="sd"&gt;    A completely made up function to illustrate *incorrect* settings import.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Connection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;we write:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;config&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;database&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connect_to_db&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;"""Connect to the database,&lt;/span&gt;

&lt;span class="sd"&gt;    A completely made up function to illustrate a *better* settings import.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Connection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;database&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="web-applications"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id5"&gt;Web applications&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;For the unit tests, mocking the database connection is sufficient. If we want to
start two instances of a web application, we need to change:&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;The database connection string.&lt;/li&gt;
&lt;li&gt;The port the application is listening on.&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;An application could be a fixture that starts a subprocess and passes the custom
port, if we use &lt;a class="reference external" href="https://circus.readthedocs.org/en/latest/"&gt;Circus&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;circus.watcher&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Watcher&lt;/span&gt;


&lt;span class="nd"&gt;@pytest.fixture&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scope&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'session'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;application&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;app_script&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Start application in a separate process.&lt;/span&gt;

&lt;span class="sd"&gt;    :param port: a random port the application should listen to.&lt;/span&gt;
&lt;span class="sd"&gt;    :param app_script: the path to application runner script.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;

    &lt;span class="n"&gt;watcher&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Watcher&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'application'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;cmd&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;app_script&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'runserver {0}'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;watcher&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;addfinalizer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;watcher&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;watcher&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This is a rather limited solution, because we did not set up the database
connection string. Furthermore, we couldn't pass it as an environment variable, nor
pass the path to the custom settings. It is however possible to pass parameters to
the script (app_script) in the example. This would help us to override the needed settings on the
&lt;strong&gt;remote&lt;/strong&gt; side. But then we should somehow marshal the complex data structures via the command line.
This would require more custom code to write.&lt;/p&gt;
&lt;p&gt;The first solution that came to mind was to use
&lt;a class="reference external" href="http://docs.python.org/2/library/multiprocessing.html#the-process-class"&gt;multiprocessing&lt;/a&gt;. This way we can use
a python function instead of a file script to be a worker for our application. Code would look as follows:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;multiprocessing&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;app_worker&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Start web application.&lt;/span&gt;

&lt;span class="sd"&gt;    :param str database_connection: the database connection string.&lt;/span&gt;
&lt;span class="sd"&gt;    :param port: the port number that will be used by runserver.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="c"&gt;# Remove modules that happen to be imported by the parent process.&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;module&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;modules&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;difference&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;builtin_module_names&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;module&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startswith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'multiprocessing'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="n"&gt;module&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;__name__&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;del&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;modules&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;module&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

    &lt;span class="c"&gt;# monkey patch the database connection&lt;/span&gt;
    &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;config&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;database&lt;/span&gt;
    &lt;span class="n"&gt;database&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;

    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.httpserver&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.ioloop&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.web&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.wsgi&lt;/span&gt;

    &lt;span class="n"&gt;wsgi_app&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wsgi&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WSGIContainer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;app_wsgi_handler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;tornado_app&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;web&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;r"/media/(.*)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;web&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StaticFileHandler&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;"path"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;media_path&lt;/span&gt;&lt;span class="p"&gt;}),&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'.*'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;web&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FallbackHandler&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fallback&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;wsgi_app&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
    &lt;span class="p"&gt;])&lt;/span&gt;

    &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;httpserver&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;HTTPServer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tornado_app&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'started app on port: {0}'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ioloop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IOLoop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;


&lt;span class="nd"&gt;@pytest.fixture&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scope&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'session'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;application&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Start application in a separate process.&lt;/span&gt;

&lt;span class="sd"&gt;    :param port: a random port the application should listen to.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;multiprocessing&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;targer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;app_worker&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;addfinalizer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;terminate&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This has one big downside: memory. Multiprocessing uses &lt;a class="reference external" href="http://docs.python.org/2/library/os.html#os.fork"&gt;fork&lt;/a&gt; to
do its work. This means that a lot of memory you've earned in the parent process will be copied into the child process.
Of course it's declared to be copy-on-write but in reality python is not that efficient here.&lt;/p&gt;
&lt;p&gt;So we decided to combine these 2 approaches: use a subprocess to run python but don't bother with marshalling
the parameters manually via command line. The nice &lt;a class="reference external" href="http://codespeak.net/execnet"&gt;execnet&lt;/a&gt; library allows us to
transparently run some python function inside of a remote python process. Here is the comprehensive example:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;execnet&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;app_worker&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Start web application.&lt;/span&gt;

&lt;span class="sd"&gt;    :param channel: execnet channel to talk to the master process.&lt;/span&gt;
&lt;span class="sd"&gt;    :param str database_connection: the database connection string.&lt;/span&gt;
&lt;span class="sd"&gt;    :param port: the port number that will be used by runserver.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="c"&gt;# monkey patch the database connection&lt;/span&gt;
    &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;config&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;database&lt;/span&gt;
    &lt;span class="n"&gt;database&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;

    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.httpserver&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.ioloop&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.web&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;tornado.wsgi&lt;/span&gt;

    &lt;span class="n"&gt;wsgi_app&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wsgi&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WSGIContainer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;app_wsgi_handler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;tornado_app&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;web&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;r"/media/(.*)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;web&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StaticFileHandler&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;"path"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;media_path&lt;/span&gt;&lt;span class="p"&gt;}),&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'.*'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;web&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FallbackHandler&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fallback&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;wsgi_app&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
    &lt;span class="p"&gt;])&lt;/span&gt;

    &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;httpserver&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;HTTPServer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tornado_app&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'started app on port: {0}'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;tornado&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ioloop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IOLoop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;


&lt;span class="nd"&gt;@pytest.fixture&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scope&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'session'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;application&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Start application in a separate process.&lt;/span&gt;

&lt;span class="sd"&gt;    :param port: a random port the application should listen to.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="c"&gt;# create execnet gateway&lt;/span&gt;
    &lt;span class="n"&gt;gw&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;execnet&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;makegateway&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="c"&gt;# set the same python system path on remote python as on current one&lt;/span&gt;
    &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
    &lt;span class="n"&gt;gw&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remote_exec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="p"&gt;[&lt;/span&gt;
            &lt;span class="s"&gt;"import sys"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;"sys.path = {0}"&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;waitclose&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="c"&gt;# create channel running worker function&lt;/span&gt;
    &lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gw&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remote_exec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;app_worker&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;database_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;addfinalizer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gw&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;gw&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In this way we can attach any customizations before starting the application.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="other-isolated-resources"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id6"&gt;Other isolated resources&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Apart from the database connection string, there are other shared resources. One
of them can be some folder where file artifacts need to be stored. They have to be isolated as
well, because the filenames can clash in concurrent test processes (a.k.a. sessions).
However, mocking can be done here in the same way as in the case of the connection string.&lt;/p&gt;
&lt;p&gt;It is also possible to use only one server but with isolated databases. We then start as many MySQL
instances as we have concurrent test sessions.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="requirements"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;Requirements&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Another nontrivial part is to distribute requirements to each node. We do this
together with the code distribution as a virtualenv. Each node then activates
it before running the tests:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;pytest_addoption&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Add options custom pytest options."""&lt;/span&gt;
    &lt;span class="n"&gt;group&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getgroup&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"xdist"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;"distributed and subprocess32 testing"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;group&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_addoption&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="s"&gt;'--activate-script'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;action&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"store"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dest&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"activate_script"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;default&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'env/bin/activate_this.py'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;help&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"Activate virtual environment script (relative path). "&lt;/span&gt;
        &lt;span class="s"&gt;"This is to make remote python aware about all the dependencies project needs."&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;pytest_configure_node&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;node&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;"""Configure node information before it gets instantiated.&lt;/span&gt;

&lt;span class="sd"&gt;    Activate the virtual env, so the node is able to import Paylogic&lt;/span&gt;
&lt;span class="sd"&gt;    dependencies.&lt;/span&gt;

&lt;span class="sd"&gt;    """&lt;/span&gt;

    &lt;span class="n"&gt;here&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basename&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dirname&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dirname&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;__file__&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
    &lt;span class="n"&gt;activate_script&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normpath&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;here&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;node&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;option&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;activate_script&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="c"&gt;# remove pyc files and activate the virtual environment on the remote side.&lt;/span&gt;
    &lt;span class="n"&gt;node&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remote_exec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="p"&gt;[&lt;/span&gt;
            &lt;span class="s"&gt;"import os.path"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;"import subprocess"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="sd"&gt;"""subprocess.check_call(['find', '-name', '"*.pyc"', '-delete'])"""&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;"activate_this = '{0}'"&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;activate_script&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="s"&gt;"if os.path.exists(activate_this):"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;"    execfile(activate_this, {'__file__': activate_this})"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;waitclose&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="results"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;Results&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Test parallelization dramatically reduced the time needed to run unit and
functional tests. It takes about 5 minutes to run unit and functional tests on a
cluster of 6 old dual core machines, each of them running 2 sessions.&lt;/p&gt;
&lt;p&gt;An experiment in the early stages gave these results:&lt;/p&gt;
&lt;img alt="parallelization performance comparison graph" class="align-center" src="http://developer.paylogic.com/images/p14n.png" style="width: 75%;"/&gt;
&lt;p&gt;The blue line is the test distribution over cluster machines, one worker on each
of them. The pink line represents the "ideal situation", where doubling the
number of works decreases the tests execution time by a factor of 2. Finally, the
yellow line is the run executed on a &lt;a class="reference external" href="http://www.asus.com/Notebooks_Ultrabooks/ASUS_ZENBOOK_UX32VD/#specifications"&gt;developer's machine&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;py.test-xdist behaves very well when it comes to parallel execution and the
overhead is relatively small.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="open-source"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;Open source&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;We announce the open source pytest plugins which simplify the process of running services (memcached, mysql, etc)
on demand for every concurrent test session.  We also will open source a helper
for scheduling test jobs among test slave nodes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Automated testing facilitates development of complex software. However, if a
lot of time is required to get a test result, automated testing will be rejected
by the majority of the team. Test parallelization and execution over several nodes
solves this problem, with as trade-off the extra effort needed to make the tests ready for
parallelization.&lt;/p&gt;
&lt;/div&gt;
</summary><category term="testing"></category><category term="parallelization"></category><category term="pytest"></category><category term="pytest-xdist"></category></entry><entry><title>Prefill Registration Data</title><link href="http://developer.paylogic.com/articles/prefill-registration.html" rel="alternate"></link><updated>2013-12-02T10:56:00+01:00</updated><author><name>Spyros Ioakeimidis</name></author><id>tag:developer.paylogic.com,2013-12-02:articles/prefill-registration.html</id><summary type="html">
&lt;p&gt;&lt;em&gt;Paylogic offers a feature to allow the prefilling of the personal data of a
consumer during the sales process via a personalized URL. This can be used
whenever a merchant already has the data of the consumers and wants to offer
these consumers a more personalized and smooth ticketing process, or when a
pre-registration step is used. The following sections describe the steps that
third parties have to implement in order to provide the possibility of
prefilling the registration form in the front office.&lt;/em&gt;&lt;/p&gt;
&lt;div class="section" id="json-data-format"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;JSON data format&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The first step is to construct the data. The data should be structured using
JSON. The JSON data should adhere to the following format:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="s2"&gt;"first_name"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"Test Client First Name"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s2"&gt;"last_name"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"Test Client Last Name"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s2"&gt;"email"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"test@testmail.com"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s2"&gt;"gender"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"1"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s2"&gt;"birth_date"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"1978-10-07"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s2"&gt;"phone_number"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"0123456789"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s2"&gt;"address"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"Address 1A"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s2"&gt;"postal_code"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"9999AB"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s2"&gt;"city"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"Groningen"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s2"&gt;"country"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"NL"&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;code&gt;gender&lt;/code&gt; attribute should contain a code according to &lt;a class="reference external" href="http://en.wikipedia.org/wiki/ISO/IEC_5218"&gt;ISO 5218&lt;/a&gt;, which specifies the following
codes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;0 = not known&lt;/li&gt;
&lt;li&gt;1 = male&lt;/li&gt;
&lt;li&gt;2 = female&lt;/li&gt;
&lt;li&gt;9 = not applicable&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The format of the &lt;code&gt;birth_date&lt;/code&gt; attribute should be &lt;code&gt;YYYY-MM-DD&lt;/code&gt;.
This format is according to &lt;a class="reference external" href="http://en.wikipedia.org/wiki/ISO_8601"&gt;ISO 8601&lt;/a&gt;.
Finally, the &lt;code&gt;country&lt;/code&gt; code attribute should contain a value according to
&lt;a class="reference external" href="http://www.iso.org/iso/country_codes/iso_3166_code_lists/country_names_and_code_elements.htm"&gt;ISO 3166&lt;/a&gt;.
For example, for The Netherlands the country code &lt;code&gt;NL&lt;/code&gt; should be used. It
should be mentioned that no certain format is required for &lt;code&gt;postal_code&lt;/code&gt;,
as long as its length is less than or equal to 12.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="compression-and-encoding"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;Compression and Encoding&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The second step is to compress and encode the data. Compression helps to reduce
the length of the data, as the URL should contain up to a maximum number of
characters. It is not only that the JSON data itself might be long. Encoding
also increases the length of the data by approximately 33%.&lt;/p&gt;
&lt;p&gt;The pseudo code below illustrates the process of encoding and compression. It
also includes the creation of the JSON data. The data should first be compressed
and then encoded.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
create the JSON data

create a string out of the JSON data

compress the data using gzip compatible compression

encode the data using base64 and make them url safe
&lt;/pre&gt;
&lt;p&gt;The way encoding and compression can be implemented depends on which programming
language is used. A simple implementation is illustrated both for Python and
PHP. If there are any questions regarding the implementation, then please contact
the Paylogic support team.&lt;/p&gt;
&lt;div class="section" id="python"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id5"&gt;Python&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The compression is done using the &lt;a class="reference external" href="http://www.zlib.net/"&gt;zlib&lt;/a&gt;
standard python module. The data is encoded to utf-8 prior to compression. Data
encoding is performed using base64 as specified in &lt;a class="reference external" href="http://tools.ietf.org/html/rfc3548.html"&gt;RFC 3548&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;json&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;zlib&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;base64&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;urlsafe_b64encode&lt;/span&gt;

&lt;span class="c"&gt;# construct the json data&lt;/span&gt;
&lt;span class="n"&gt;json_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;"first_name"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;"Test Client First Name"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="c"&gt;# create a string of the json data&lt;/span&gt;
&lt;span class="n"&gt;json_data_string&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dumps&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;json_data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c"&gt;# encode the data to utf8 and compress it&lt;/span&gt;
&lt;span class="n"&gt;compressed_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;zlib&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;json_data_string&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'utf8'&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="c"&gt;# encode the data using base64 and urlsafe&lt;/span&gt;
&lt;span class="n"&gt;encoded&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urlsafe_b64encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;compressed_data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="php"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id6"&gt;PHP&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The compression is done using the &lt;a class="reference external" href="http://php.net/manual/en/function.gzcompress.php"&gt;gzcompress&lt;/a&gt;
method, which uses the &lt;a class="reference external" href="http://www.zlib.net/"&gt;zlib&lt;/a&gt; data format. The data is
encoded to utf-8 prior to compression. Data encoding is performed using base64
as specified in &lt;a class="reference external" href="http://tools.ietf.org/html/rfc3548.html"&gt;RFC 3548&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class="c1"&gt;# create a string of the json data&lt;/span&gt;
&lt;span class="nv"&gt;$json_data_string&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;'{"first_name": "Test Client First Name", ... }'&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="c1"&gt;# encode data to utf8 and compress it&lt;/span&gt;
&lt;span class="nv"&gt;$compressed_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;gzcompress&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;utf8_encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$json_data_string&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;

&lt;span class="c1"&gt;# encode the data using base64&lt;/span&gt;
&lt;span class="nv"&gt;$encoded_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;base64_encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$compressed_data&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;

&lt;span class="c1"&gt;# make data urlsafe&lt;/span&gt;
&lt;span class="nv"&gt;$encoded_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;str_replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'+'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;'/'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="k"&gt;array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'-'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;'_'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="nv"&gt;$encoded_data&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="cp"&gt;?&amp;gt;&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="transferring-the-data"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;Transferring the data&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The third step is to append the encoded and compressed data to the landing page
URL. The landing page URL is the URL that is usually included within the
invitation emails. The encoded and compressed data should be appended to the
landing page URL &lt;strong&gt;after&lt;/strong&gt; the fragment identifier (&lt;strong&gt;#&lt;/strong&gt;). The advantage of
this approach is that data after the fragment identifier is not sent over the
network and is only used client-side.&lt;/p&gt;
&lt;p&gt;The implementation of this is left to the third parties. The only constraint is
that the appended data should have a specific form. We assume that the landing
page URL contains some query parameters (substituted with '...' in the
following example for clarity) and &lt;code&gt;FGRAhdfhasAHDFA&lt;/code&gt; is the encoded and
compressed data. Then, a landing page URL with the appended data would have the
following form:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
http://tickets.company.com/?...#pld=FGRAhdfhasAHDFA
&lt;/pre&gt;
&lt;p&gt;It is important to use &lt;code&gt;pld&lt;/code&gt; as a parameter, as this is also used on the
side of Paylogic, when retrieving the data from the URL. The above method will
work if Paylogic handles the creation of the landing page.&lt;/p&gt;
&lt;div class="section" id="third-party-handles-landing-page"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id8"&gt;Third party handles landing page&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;In case a third party handles the creation of the landing page, then one more
step needs to be performed. The Javascript code below should be appended at the
end of the landing page HTML document. This ensures that the data is read from
the landing page URL and that it is appended in the queue URL, which resides as
an iframe inside the landing page HTML document.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nt"&gt;&amp;lt;script &lt;/span&gt;&lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;"text/javascript"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;getHashParam&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="nb"&gt;window&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;location&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;hash&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sr"&gt;/([^#&amp;amp;]+)/g&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;match&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// This is to ensure that if the variable contains '=' then they remain in the value.&lt;/span&gt;
    &lt;span class="c1"&gt;// for example: pld=FHadfsdhFJASDF3423==&lt;/span&gt;
    &lt;span class="c1"&gt;// In this case:&lt;/span&gt;
    &lt;span class="c1"&gt;//   key: pld&lt;/span&gt;
    &lt;span class="c1"&gt;//   value: FHadfsdhFJASDF3423==&lt;/span&gt;
    &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;param&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;match&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sr"&gt;/=(.+)?/&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;param&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;===&lt;/span&gt; &lt;span class="s2"&gt;"pld"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;queue&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;document&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;getElementById&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'paylogic-frontoffice'&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="nx"&gt;queue&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;src&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;queue&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;src&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;'#'&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;param&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;'='&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;param&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
  &lt;span class="p"&gt;});&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;span class="nx"&gt;getHashParam&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="integration"></category></entry><entry><title>You are welcome</title><link href="http://developer.paylogic.com/articles/you-are-welcome.html" rel="alternate"></link><updated>2013-06-19T18:00:00+02:00</updated><author><name>Berco Beute</name></author><id>tag:developer.paylogic.com,2013-06-19:articles/you-are-welcome.html</id><summary type="html">
&lt;div class="section" id="you-are-welcome"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id1"&gt;You are welcome&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;We at Paylogic are passionate about software. We have the craft of software engineering on a pedestal, we love to write clean code, we are interested in high availability, we are intrigued by distributed systems, we like to experiment with emerging technologies, we take pride in the applications we write, deploy and maintain. And we are fortunate enough to be able to live our passion through our jobs. Paylogic is a company that is both commercially and technically quite ambitious. Its goal is to redesign the world of ticketing with creative and reliable ticketing solutions which empower the event organizer in their relation with their visitors. The commercial ambitions are achieved through technical leadership. Technical leadership is achieved by both hiring top software engineers and selecting the right technologies and tools. One of the fundamental choices in that respect is the commitment to open source software. Paylogic is fully built upon open source software and firmly rooted in the open source culture. Some key technologies we use are for example Python, SQLAlchemy, Django, Flask, JavaScript and MySQL. Interestingly enough the Zen of Python is largely used as guidance for running the technical side of Paylogic. But we are not just using open source software, we are also actively giving back. We contribute to many open source projects, we run PyGrunn, the biggest Python conference in the Netherlands, we open source as much of the software we write as possible, we give lectures at universities about our work, and we participate in a number of open source related conferences. Somehow all of our open source efforts were quite detached and independent. This developer portal and blog should change that. This will be the central hub for the outside world to learn about the technology within Paylogic. We will announce open source projects and write about technical topics.&lt;/p&gt;
&lt;p&gt;In the end it is all about sharing, and we share because we care. We hope you appreciate our effort and share back. Whether it is code, ideas or feedback. So welcome to the tech world of Paylogic and please join the discussions!&lt;/p&gt;
&lt;/div&gt;
</summary><category term=""></category></entry><entry><title>Continuous Delivery</title><link href="http://developer.paylogic.com/articles/continuous-delivery.html" rel="alternate"></link><updated>2013-05-30T01:08:00+02:00</updated><author><name>Òscar Vilaplana</name></author><id>tag:developer.paylogic.com,2013-05-30:articles/continuous-delivery.html</id><summary type="html">
&lt;p&gt;&lt;em&gt;When you do Continuous Delivery you can deploy whenever you want: you
made it as easy as possible and you have become very good at it.
Everyone in the Engineering and Operations teams knows how to deploy
your application to any environment. Product can always see the latest
bells and whistles as they are built because you have Stable servers
running the latest versions of the application. You implement big
changes gradually and show them to the Product Team while keeping the
customer’s experience stable. When you decide to release, you have made
sure all things will work and you know how to react if nevertheless they
break, without fires or panic.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Continuous Deployment also forces you to do many right things:
repeatable builds; the exact same deployment process in all
environments, including the developer’s machines and a development
environment that is as close as possible to Production;
backwards-compatible database changes; easy rollbacks; code that is
split into components; good tests…&lt;/em&gt;&lt;/p&gt;
&lt;div class="section" id="taming-the-software-lion"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;Taming the Software Lion&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="s"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id4"&gt;1800s&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;It’s the 1800s. The lion is beaten into submission through fear, brute
force and confusion. That famous tamer wielding a chair—the lion is not
scared of the chair, it’s confused of it: why is this chair floating
here? And why is this guy holding it?&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="modern-times"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id5"&gt;Modern times&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Nowadays tamers understand the lion’s psychology. They condition the
lion to behave as they want, they tie behaviors to signals and reward
the right behaviors. They build up trust.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="taming-the-software-lionrecap"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;Taming the Software Lion—recap&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="id1"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id7"&gt;1800s&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;It’s the 1800s. Code is beaten into submission through iterations of
half-working attempts at hand-made deployments; with fear, because it
works and we barely understand it, so don’t touch it because &lt;em&gt;it works&lt;/em&gt;;
with weapons, because when it breaks it’s hacked some more until it
works (install a missing dependency, copy the forgotten templates…); and
with confusion: it’s difficult to see what’s actually installed, how,
what part of it is needed and what extra changes are needed to make it
work.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id8"&gt;Modern times&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Nowadays software engineers understand that deploying software is hard,
and so they must get very good at it and automate it with clean
procedures so that it’s repeatable and debugable. They use continuous
integration, which rewards them with a green light when the build
passes. They take care of the health of the build. They deploy it
frequently to a staging server that the stakeholders can see. When
software breaks, they know how to act.&lt;/p&gt;
&lt;p&gt;Engineers build up trust: they can trust that the software works and
that it does what it’s supposed to do; and the stakeholders trust them
in that the product is built to their expectations.&lt;/p&gt;
&lt;div class="section" id="what-you-need-to-implement-continuous-delivery"&gt;
&lt;h4&gt;What You Need to implement Continuous Delivery&lt;/h4&gt;
&lt;p&gt;To implement Continuous Delivery, you need the following:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;A team&lt;/li&gt;
&lt;li&gt;Working software&lt;/li&gt;
&lt;li&gt;A repeatable build&lt;/li&gt;
&lt;li&gt;An automated deployment&lt;/li&gt;
&lt;li&gt;A way to rollback&lt;/li&gt;
&lt;li&gt;An automated release&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="team"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;Team&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Every single member of the Team must be committed to quality—process
can’t compensate for lack of commitment. This commitment includes the
constant learning of best practices and ways to improve.&lt;/p&gt;
&lt;p&gt;Everyone in the Team must know how to deploy and release software (also
in Live) and how to maintain the deployment and release scripts.
Everyone is responsible for these scripts: there cannot be a deployment
guru. For this, the deployment scripts must be clear, concise and
simple.&lt;/p&gt;
&lt;p&gt;All environments must be as similar as possible; this includes the
development machines. The Team must deploy the software in their
development machines using the exact same deployment and release scripts
that are used in Production and Staging.&lt;/p&gt;
&lt;p&gt;In addition to this, everyone in the Team is responsible for:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Having working Stable and Production environments.&lt;/li&gt;
&lt;li&gt;Having a green CI.&lt;/li&gt;
&lt;li&gt;Never committing broken code.&lt;/li&gt;
&lt;li&gt;Adding sufficient tests.&lt;/li&gt;
&lt;li&gt;Having good quality code.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="working-software"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;Working Software&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Software, even software that &lt;em&gt;works&lt;/em&gt;, is not working software unless it
has automated tests:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Unit Tests&lt;/li&gt;
&lt;li&gt;Functional Tests&lt;/li&gt;
&lt;li&gt;Acceptance Tests (testing from the user’s viewpoint, not from a lower
layer)&lt;/li&gt;
&lt;li&gt;Infrastructure and Configuration Tests (for example, testing that the
server must be able to send e-mail).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Tests are not second-class citizens: the standards of their cleanness,
readability and maintainability must be as high as those of the rest of
the software. This quality must be maintained: tests must not be let rot
when changes accumulate.&lt;/p&gt;
&lt;p&gt;All these tests must be run locally before committing changes and also
automatically using Continuous Integration. Because tests are executed
often they should be kept fast.&lt;/p&gt;
&lt;p&gt;Simple mistakes, such as the ones that pylint catches, should be checked
even before running any tests.&lt;/p&gt;
&lt;p&gt;The build must be kept green at all times. Engineers should check in
their changes often, and be ready to rollback if the change (which
passed the local tests) breaks the build. Many small changes are
preferable to a single big change: they are easier to debug and to
rollback.&lt;/p&gt;
&lt;p&gt;Both Engineering and QA are responsible for the quality of the software
(this includes the tests).&lt;/p&gt;
&lt;p&gt;When a test breaks, it must be fixed. There are two possible moments for
fixing it:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Right now. If the failure is legit, you must drop what you are doing
and fix the it.&lt;/li&gt;
&lt;li&gt;As soon as possible. If the failure is due to a false positive and
it’s not possible to fix it right now, the test must be fixed as soon
as possible. This should not be later than the end of the day.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If a test breaks because of changes that are being made, either the test
must be fixed right now or the changes must be reverted.&lt;/p&gt;
&lt;p&gt;Tests cannot be disabled to be fixed later. Later won’t come any time
soon.&lt;/p&gt;
&lt;p&gt;Any code must be peer-reviewed before being merged into the Stable
branch.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="repeatable-build"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;Repeatable Build&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The build must be automated, and used by all members of the Team in all
environments. The build process must contain no manual steps or changes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="deployment-script"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id12"&gt;Deployment Script&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As for the build, the deployment script must be automated and used by
all members of the Team in all environments. Deploying the software
should be accomplished by a single command:&lt;/p&gt;
&lt;blockquote&gt;
&lt;em&gt;./deploy.sh&lt;/em&gt; &amp;lt;environment&amp;gt; &amp;lt;version&amp;gt;&lt;/blockquote&gt;
&lt;p&gt;The only way to deploy is to follow the pipeline: tests, peer-review,
merge, test, automated build, automated deploy. This includes
emergencies: many problems come from skipping the pipeline and hacking a
solution out of urgency.&lt;/p&gt;
&lt;p&gt;If the pipeline is skipped and software is deployed by hand, the system
is left on an unknown state. If the hack fails it will be very difficult
to duplicate it and investigate what went wrong. Most of the time of
fixing a problem is usually spent in searching its cause.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="rollback"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id13"&gt;Rollback&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;When a deployment fails it must be easy to rollback. There are many
strategies to accomplish this, for example Blue-Green Deployments and
Canary Deployments.&lt;/p&gt;
&lt;div class="section" id="blue-green-deployments"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id14"&gt;Blue-Green Deployments&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Have two separate environments: green is where the customers go when
they go to Production; blue is not.&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Deploy the new version on blue.&lt;/li&gt;
&lt;li&gt;Test blue and do manual acceptance.&lt;/li&gt;
&lt;li&gt;Switch blue to green and green to blue: now Blue is serving
Production&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;If the deployment goes wrong, rolling back is a matter of switching
green and blue. It’s easy to investigate what went wrong because blue is
still running the new code.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="canary-deployment"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id15"&gt;Canary Deployment&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Deploy the new version on a fraction of the servers and have it run
alongside the old version. Once it’s confirmed that it works as
expected, extend the deployment to the rest of the servers.&lt;/p&gt;
&lt;p&gt;This strategy can also be used to do A/B testing or assessing the
performance impact of new features.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="rollback-the-database"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id16"&gt;Rollback the Database&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;For rollbacks to be possible, the database changes must be kept
backwards compatible. There is no way around this. When this is not
possible, make a plan on how to rollback.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="automated-release"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id17"&gt;Automated Release&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;When all the previous steps are in place, an automated release is just
the last step on the chain. While an automated release to Production may
not be desirable in all cases, an automated release to a Staging or
Integration environment will allow the stakeholders to use the latest
version of the software while it’s being developed and before it goes to
Production.&lt;/p&gt;
&lt;p&gt;Frequent, smaller changes are preferred to a big release: small releases
have shorter Time to Recover: if it goes wrong it will be easier to find
what went wrong if the amount of changes is small.&lt;/p&gt;
&lt;p&gt;Releasing is hard. If it hurts, do it more often.&lt;/p&gt;
&lt;div class="section" id="hidden-features"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id18"&gt;Hidden Features&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;In some cases it is useful to release features but keep them
inaccessible or only accessible to a few users. There are several tools
to make this easy;
&lt;a class="reference external" href="https://github.com/disqus/gargoyle"&gt;gargoyle&lt;/a&gt;
is a popular one for Django.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="tips"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id19"&gt;Tips&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="split-in-components"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id20"&gt;Split In Components&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Split your software in components that can be deployed independently.&lt;/p&gt;
&lt;p&gt;A component:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Is reusable&lt;/li&gt;
&lt;li&gt;Is replaceable with something else that implements the same API.&lt;/li&gt;
&lt;li&gt;Is independently deployable.&lt;/li&gt;
&lt;li&gt;Encapsulates a coherent set of behaviors and responsibilities of the
system.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Splitting your software in components encourages a clear delineation of
responsibilities and makes understanding and changing the code easier.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="rehearse-releases"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id21"&gt;Rehearse Releases&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Releasing is hard. Rehearse it and get very good at it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="manage-your-infrastructure"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id22"&gt;Manage your Infrastructure&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Write tests that verify that your infrastructure behaves as you expect
and provides the necessary functionality.&lt;/p&gt;
&lt;p&gt;Automate all infrastructure changes that can be automated, and document
the rest.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="equal-environments"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id23"&gt;Equal Environments&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;All environments must be as similar as possible. Use
&lt;a class="reference external" href="http://www.vagrantup.com/"&gt;vagrant&lt;/a&gt;
to develop.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="automate-everything"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id24"&gt;Automate Everything&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;A process that is automated is repeatable and easier to debug. Automate
everything that can be automated.&lt;/p&gt;
&lt;hr class="docutils"/&gt;
&lt;p&gt;I gave a talk about this at DjangoCon Europe 2013. Here are the
&lt;a class="reference external" href="https://bitbucket.org/grimborg/continuousdeployment/src/tip/continuous-deployment.pdf"&gt;slides&lt;/a&gt;;
the video will be available soon.&lt;/p&gt;
&lt;p&gt;If this interests you, you may want to check these books:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.amazon.com/Continuous-Delivery-Deployment-Automation-Addison-Wesley/dp/0321601912/ref=sr_1_1?ie=UTF8&amp;amp;qid=1369904950&amp;amp;sr=8-1"&gt;Continuous Delivery: Reliable Software Releases through Build, Test, and Deployment Automation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.amazon.com/Continuous-Integration-Improving-Software-Reducing/dp/0321336380/ref=sr_1_1?ie=UTF8&amp;amp;qid=1369905064&amp;amp;sr=8-1"&gt;Continuous Integration: Improving Software Quality and Reducing Risk&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.amazon.com/Agile-Testing-Practical-Guide-Testers/dp/0321534468/ref=sr_1_1?ie=UTF8&amp;amp;qid=1369905098&amp;amp;sr=8-1"&gt;Agile Testing: A Practical Guide for Testers and Agile Team&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.amazon.com/Test-Driven-Development-Kent-Beck/dp/0321146530/ref=sr_1_1?s=books&amp;amp;ie=UTF8&amp;amp;qid=1369905116&amp;amp;sr=1-1"&gt;Test Driven Development: By Example&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="agile"></category><category term="continuous delivery"></category><category term="deployment"></category><category term="release"></category><category term="testing"></category><category term="qa"></category></entry><entry><title>Using Debian packages for Python deployments</title><link href="http://developer.paylogic.com/articles/debian-packages.html" rel="alternate"></link><updated>2013-05-14T00:28:00+02:00</updated><author><name>Peter Odding</name></author><id>tag:developer.paylogic.com,2013-05-14:articles/debian-packages.html</id><summary type="html">
&lt;p&gt;At Paylogic we use Debian packages to deploy our Python applications. This
article explains how we got started.&lt;/p&gt;
&lt;p&gt;This is a large article but if you just want to get started building Debian
packages you can jump straight to the section on &lt;a class="reference internal" href="#getting-started-with-debian-packaging"&gt;getting started with Debian
packaging&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="disadvantages-of-python-packages"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;Disadvantages of Python packages&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Python has its own packaging infrastructure and there are a lot of people who
like it, but for us it doesn't come close to a full solution:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://pypi.python.org"&gt;PyPI&lt;/a&gt; and/or distribution websites go down regularly, usually at the exact
time you need them to perform a live deployment :-)&lt;/li&gt;
&lt;li&gt;Python packages cannot and therefore do not declare their binary dependencies,
because there is no portable way to do so (the packages names are different
in every Linux distribution, let alone other operating systems)&lt;/li&gt;
&lt;li&gt;Python packages don't control init.d scripts, cron tabs, configuration files,
etc. while we really do need to install and manage these files...&lt;/li&gt;
&lt;li&gt;What's with the whole &lt;a class="reference external" href="http://docs.python.org/2/library/distutils.html"&gt;Distutils&lt;/a&gt;, &lt;a class="reference external" href="https://pypi.python.org/pypi/setuptools"&gt;Setuptools&lt;/a&gt;, &lt;a class="reference external" href="https://pypi.python.org/pypi/distribute"&gt;Distribute&lt;/a&gt;, &lt;a class="reference external" href="https://pypi.python.org/pypi/Distutils2"&gt;Distutils2&lt;/a&gt; and
&lt;a class="reference external" href="https://pypi.python.org/pypi/distlib"&gt;Distlib&lt;/a&gt; confusion?! Please for the love of god just merge the common
subset, bless one tool and get this whole mess over with already! For more
details about this subject see &lt;a class="reference external" href="http://stackoverflow.com/questions/6344076/differences-between-distribute-distutils-setuptools-and-distutils2/14753678#14753678"&gt;Differences between distribute, distutils,
setuptools and distutils2?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="virtual-environments"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id4"&gt;Virtual environments&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;There's one more significant thing, which is that Python packages favor virtual
environments over system wide installations. Why do we say this?&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;easy_install&lt;/tt&gt; doesn't support removal of packages&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;pip&lt;/tt&gt; does support removal of packages but does not support anything like
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;apt-get&lt;/span&gt; autoremove&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;One of our problems with virtual environments is that we've seen them break in
various ways, for example because of security updates to the system-wide Python
installation (Google for &lt;a class="reference external" href="https://www.google.com/search?q=ImportError%3A%20cannot%20import%20name%20urandom"&gt;ImportError: cannot import name urandom&lt;/a&gt;). This is
one of the reasons why we prefer virtual machines over virtual environments to
isolate our production deployments.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="making-sense-of-the-python-packaging-ecosystem"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id5"&gt;Making sense of the Python packaging ecosystem&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;As mentioned above the Python packaging ecosystem is a bit of a mess. For an
overview of the situation and some of the problems, refer to the following
external resources:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://guide.python-distribute.org/introduction.html#current-state-of-packaging"&gt;The Hitchhiker's Guide to Packaging: Current State of Packaging&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://lucumr.pocoo.org/2012/6/22/hate-hate-hate-everywhere/"&gt;Python Packaging: Hate, hate, hate everywhere&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://blog.workaround.org/setuptools-versioning-wtf"&gt;setuptools versioning - wtf?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I sometimes hear people call Debian package management complex. They certainly
have a point, but as a DevOps who wants to do their work properly, Debian and
Python are both complex, the difference is that Debian is (mostly) a pleasure
to work with... The Python packaging ecosystem is very fragmented and
underdocumented while in Debian there is almost always a canonical, documented
way to do things properly.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="advantages-of-debian-packages"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;Advantages of Debian packages&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Here are a couple of notable advantages of using Debian packages:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;They provide a controlled process for installing, removing, upgrading and
downgrading packages (for example for doing new releases, but also rolling
back existing releases)&lt;/li&gt;
&lt;li&gt;Dependencies on operating system packages are formalized as proper package
dependencies instead of being written down in wiki pages, personal notes, or
worse, not written down at all...&lt;/li&gt;
&lt;li&gt;The steps that should be executed in every environment where a package is
deployed are formalized in pre/post installation/removal scripts&lt;/li&gt;
&lt;li&gt;The packages are built on a dedicated host so production machines don't need
a build environment&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There's also the fact that we get to use &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;apt-get&lt;/span&gt;&lt;/tt&gt; more and we (generally)
love &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;apt-get&lt;/span&gt;&lt;/tt&gt; :-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;span id="getting-started-with-debian-packaging"&gt;&lt;/span&gt;&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;Getting started with Debian packaging&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Debian package management is a complex topic, however getting started requires
little upfront knowledge nor does it require a complex build environment. In
fact most of the tools you'll need are probably already installed if you're
running Debian or a derivative Linux distribution!&lt;/p&gt;
&lt;div class="section" id="creating-your-first-debian-package"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id8"&gt;Creating your first Debian package&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;To create a simple Debian package we only need a single file and a single
command. Here's how you get started:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Create a directory to hold the files contained in the package.&lt;/span&gt;
mkdir my-package &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="nb"&gt;cd &lt;/span&gt;my-package

&lt;span class="c"&gt;# Create a directory with the package's control files.&lt;/span&gt;
mkdir DEBIAN

&lt;span class="c"&gt;# Create the main control file with package metadata.&lt;/span&gt;
cat &amp;gt; DEBIAN/control &lt;span class="s"&gt;&amp;lt;&amp;lt; EOF&lt;/span&gt;
&lt;span class="s"&gt;Package: name-of-package&lt;/span&gt;
&lt;span class="s"&gt;Version: 1.0&lt;/span&gt;
&lt;span class="s"&gt;Section: universe/web&lt;/span&gt;
&lt;span class="s"&gt;Priority: optional&lt;/span&gt;
&lt;span class="s"&gt;Architecture: all&lt;/span&gt;
&lt;span class="s"&gt;Installed-Size: 1&lt;/span&gt;
&lt;span class="s"&gt;Maintainer: $USER&lt;/span&gt;
&lt;span class="s"&gt;Description: Explanation of why name-of-package is so cool&lt;/span&gt;
&lt;span class="s"&gt;EOF&lt;/span&gt;

&lt;span class="c"&gt;# Build the package using the accepted naming scheme.&lt;/span&gt;
&lt;span class="nv"&gt;NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;awk &lt;span class="s1"&gt;'/^Package:/ {print $2}'&lt;/span&gt; DEBIAN/control&lt;span class="k"&gt;)&lt;/span&gt;
&lt;span class="nv"&gt;VERSION&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;awk &lt;span class="s1"&gt;'/^Version:/ {print $2}'&lt;/span&gt; DEBIAN/control&lt;span class="k"&gt;)&lt;/span&gt;
&lt;span class="nv"&gt;ARCH&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;awk &lt;span class="s1"&gt;'/^Architecture:/ {print $2}'&lt;/span&gt; DEBIAN/control&lt;span class="k"&gt;)&lt;/span&gt;
dpkg-deb --build . &lt;span class="nv"&gt;$NAME_&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;_&lt;span class="nv"&gt;$ARCH&lt;/span&gt;.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Assuming you're on a Debian/Ubuntu system, the above commands should be enough
to build a simple package. Any files in the working directory (excluding the
special &lt;tt class="docutils literal"&gt;DEBIAN&lt;/tt&gt; directory) will be included in the package as if the
directory containing the &lt;tt class="docutils literal"&gt;DEBIAN&lt;/tt&gt; package is the root of the file system.&lt;/p&gt;
&lt;p&gt;The resulting &lt;tt class="docutils literal"&gt;*.deb&lt;/tt&gt; file can be installed using &lt;tt class="docutils literal"&gt;dpkg &lt;span class="pre"&gt;-i&lt;/span&gt; $filename&lt;/tt&gt;,
however this won't automatically install dependencies, instead &lt;tt class="docutils literal"&gt;dpkg&lt;/tt&gt; will
error out when dependencies are missing... When this happens you can run
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;apt-get&lt;/span&gt; install &lt;span class="pre"&gt;-f&lt;/span&gt;&lt;/tt&gt; to install the dependencies. After that you can rerun
the &lt;tt class="docutils literal"&gt;dpkg&lt;/tt&gt; command; it should now succeed. Read on if you're interested in a
more streamlined experience.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="creating-a-debian-package-repository"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id9"&gt;Creating a Debian package repository&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;As mentioned earlier &lt;tt class="docutils literal"&gt;dpkg&lt;/tt&gt; doesn't automatically pull in dependencies. If
you use &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;apt-get&lt;/span&gt;&lt;/tt&gt; it will do what you expect however &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;apt-get&lt;/span&gt;&lt;/tt&gt; does not
support installation of local &lt;tt class="docutils literal"&gt;*.deb&lt;/tt&gt; archives; it needs a repository. In
other words, once you start using dependencies you will want to setup a Debian
package repository for your packages! Here's how you get started:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Create repository layout, copy packages.&lt;/span&gt;
mkdir -p repo/binary
cp *.deb repo/binary
&lt;span class="nb"&gt;cd &lt;/span&gt;repo

&lt;span class="c"&gt;# Create list of packages.&lt;/span&gt;
rm -f Packages Packages.gz Release Release.gpg  &lt;span class="c"&gt;# cleanup after previous run&lt;/span&gt;
dpkg-scanpackages -m . &lt;span class="p"&gt;|&lt;/span&gt; sed &lt;span class="s1"&gt;'s@: \./@: @'&lt;/span&gt; &amp;gt; Packages

&lt;span class="c"&gt;# Create compressed copy of list.&lt;/span&gt;
cat Packages &lt;span class="p"&gt;|&lt;/span&gt; gzip &amp;gt; Packages.gz

&lt;span class="c"&gt;# Generate release file.&lt;/span&gt;
rm -f Release Release.gpg  &lt;span class="c"&gt;# cleanup after previous run&lt;/span&gt;
&lt;span class="nv"&gt;LANG&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt; apt-ftparchive release . &amp;gt; Release.tmp
mv Release.tmp Release

&lt;span class="c"&gt;# Sign release file.&lt;/span&gt;
rm -f Release.gpg  &lt;span class="c"&gt;# cleanup after previous run&lt;/span&gt;
gpg -abs -o Release.gpg Release
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There are several gotcha's in the above piece of shell script:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;We cleanup generated files from previous runs because their presence
corrupts the generated files&lt;/li&gt;
&lt;li&gt;We modify the output of &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;dpkg-scanpackages&lt;/span&gt;&lt;/tt&gt; to change for example
&lt;tt class="docutils literal"&gt;./test_1.0_all.deb&lt;/tt&gt; to &lt;tt class="docutils literal"&gt;test_1.0_all.deb&lt;/tt&gt; (for some reason &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;apt-get&lt;/span&gt;&lt;/tt&gt;
doesn't like &lt;tt class="docutils literal"&gt;Packages&lt;/tt&gt; files with leading &lt;tt class="docutils literal"&gt;./&lt;/tt&gt; fragments)&lt;/li&gt;
&lt;li&gt;We clear the &lt;tt class="docutils literal"&gt;$LANG&lt;/tt&gt; environment variable so that we are sure the
&lt;tt class="docutils literal"&gt;Release&lt;/tt&gt; file is properly formatted regardless of the value of &lt;tt class="docutils literal"&gt;$LANG&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;You need to have a private GPG key to sign the &lt;tt class="docutils literal"&gt;Release&lt;/tt&gt; file; if you don't
have one yet you'll need to create one using the command &lt;tt class="docutils literal"&gt;gpg &lt;span class="pre"&gt;--gen-key&lt;/span&gt;&lt;/tt&gt;
(you may find this &lt;a class="reference external" href="http://www.madboa.com/geek/gpg-quickstart/"&gt;GPG quick start&lt;/a&gt; useful)&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="hosting-the-package-repository"&gt;
&lt;h4&gt;Hosting the package repository&lt;/h4&gt;
&lt;p&gt;After running the above commands, the directory &lt;cite&gt;repo/&lt;/cite&gt; can be served using a
regular web server (e.g. &lt;a class="reference external" href="http://httpd.apache.org/"&gt;Apache&lt;/a&gt; or &lt;a class="reference external" href="http://nginx.org/"&gt;Nginx&lt;/a&gt;). No specific configuration is
required because the repository contains only static files.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="using-the-package-repository"&gt;
&lt;h4&gt;Using the package repository&lt;/h4&gt;
&lt;p&gt;The package repository can be registered in a Debian/Ubuntu system by creating
the file &lt;tt class="docutils literal"&gt;/etc/apt/sources.list.d/example.sources.list&lt;/tt&gt; with the following
contents:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
deb http://server-address ./
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="installing-the-gpg-key"&gt;
&lt;h4&gt;Installing the GPG key&lt;/h4&gt;
&lt;p&gt;Before the package repository can be used from remote machines, the GPG key
used to sign the Release file has to be installed on the remote machines.
Assuming you have SSH and sudo access to the server where you generated the GPG
key &lt;cite&gt;and&lt;/cite&gt; the one where you want to install the GPG key, the following command
will install the GPG key:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;ssh build-server sudo -i gpg --armor --export &lt;span class="p"&gt;|&lt;/span&gt; ssh target-host sudo apt-key add -
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="wrapping-up"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;Wrapping up&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;That's it really, at least to get started. Now consider how easy it is to write
some Python scripts that automatically build these packages for you based on
the contents of one or more version control systems and suddenly you're looking
at a viable deployment strategy!&lt;/p&gt;
&lt;p&gt;There are even people who build Python &lt;a class="reference external" href="http://www.virtualenv.org/en/latest/"&gt;virtual environments&lt;/a&gt; and ship those
in Debian packages. It may sound revolting at first, but give it a moment to
sink in; it has its advantages :-)&lt;/p&gt;
&lt;p&gt;In future articles we'll dive into more advanced topics like pre/post
installation/removal scripts, dpkg triggers and generation of configuration
files. Stay tuned!&lt;/p&gt;
&lt;!-- External references: --&gt;
&lt;/div&gt;
</summary><category term="python"></category><category term="deployment"></category><category term="automation"></category><category term="debian"></category><category term="packaging"></category></entry><entry><title>pip-accel: Accelerator for pip, the Python package manager</title><link href="http://developer.paylogic.com/articles/pip-accel.html" rel="alternate"></link><updated>2013-05-14T00:28:00+02:00</updated><author><name>Peter Odding</name></author><id>tag:developer.paylogic.com,2013-05-14:articles/pip-accel.html</id><summary type="html">
&lt;p&gt;Recently we published &lt;a class="reference external" href="https://github.com/paylogic/pip-accel"&gt;pip-accel&lt;/a&gt; to &lt;a class="reference external" href="https://github.com/paylogic/pip-accel"&gt;GitHub&lt;/a&gt; and &lt;a class="reference external" href="https://pypi.python.org/pypi/pip-accel"&gt;PyPI&lt;/a&gt;, in this article we'll
tell you why and how we created this project.&lt;/p&gt;
&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id1"&gt;Introduction&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The pip-accel program is a wrapper for &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt;, the Python package manager. It
accelerates the usage of pip to initialize Python &lt;a class="reference external" href="http://www.virtualenv.org/en/latest/"&gt;virtual environments&lt;/a&gt; given
one or more &lt;a class="reference external" href="http://www.pip-installer.org/en/latest/cookbook.html#requirements-files"&gt;requirements&lt;/a&gt; files. It does so by combining the following two
approaches:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Source distribution downloads are cached and used to generate a local index
of source distribution archives. If all your dependencies are pinned to
absolute versions whose source distribution downloads were previously
cached, pip-accel won't need a network connection at all! This is one of the
reasons why pip can be so slow: given absolute pinned dependencies available
in the download cache it will still scan PyPI (the online Python package
index) and distribution websites.&lt;/li&gt;
&lt;li&gt;Binary distributions are used to speed up the process of installing
dependencies with binary components (like M2Crypto and LXML). Instead of
recompiling these dependencies again for every virtual environment we
compile them once and cache the result as a binary &lt;tt class="docutils literal"&gt;*.tar.gz&lt;/tt&gt;
distribution.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In the rest of this article we will discuss why pip-accel was created and dive
into the particulars of how it works. At the end we'll also look at some
related projects.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="at-paylogic-we-deploy-our-code-bases-a-lot"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id2"&gt;At Paylogic we deploy our code bases a lot&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Currently we have the following environments where we deploy our code bases:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Work laptops of the engineers and devops&lt;/li&gt;
&lt;li&gt;Continuous integration server with 10 slaves (we are using &lt;a class="reference external" href="http://jenkins-ci.org/"&gt;Jenkins&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;Stable testing environment (continuously deployed)&lt;/li&gt;
&lt;li&gt;Staging testing environment (managed w/ releases)&lt;/li&gt;
&lt;li&gt;Production servers&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In some of these environments (specifically in the continuous integration and
stable environments) new code bases can be deployed every few minutes when
engineers are publishing new changes or tested changes are being merged into
the main repository.&lt;/p&gt;
&lt;div class="section" id="python-deployment-strategies"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id3"&gt;Python deployment strategies&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;For Python deployments there are two main ways to deploy a project and its dependencies:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;System-wide installation&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.virtualenv.org/en/latest/"&gt;Virtual environments&lt;/a&gt; (or an equivalent construction, isolated from the system)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;At Paylogic we use system-wide installations on production (like) hosts and
virtual environments everywhere else. Why don't we use virtual environments on
production systems? Virtual environments do have some drawbacks (see below) and
we have the luxury of being able to isolate applications on the level of
virtual machines instead of Python virtual environments. This additional layer
of isolation is worth it for us.&lt;/p&gt;
&lt;div class="section" id="drawbacks-of-virtual-environments"&gt;
&lt;h4&gt;Drawbacks of virtual environments&lt;/h4&gt;
&lt;p&gt;Python virtual environments are by their nature a bit fragile. Quoting from
&lt;a class="reference external" href="http://virtualenv.org/en/latest/news.html"&gt;the virtualenv website&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;strong&gt;Warning:&lt;/strong&gt; &lt;em&gt;Python bugfix releases 2.6.8, 2.7.3, 3.1.5 and 3.2.3 include
a change that will cause import random to fail with “cannot import name
urandom” on any virtualenv created on a Unix host with an earlier release
of Python 2.6/2.7/3.1/3.2, if the underlying system Python is upgraded.
This is due to the fact that a virtualenv uses the system Python’s standard
library but contains its own copy of the Python interpreter, so an upgrade
to the system Python results in a mismatch between the version of the
Python interpreter and the version of the standard library. It can be fixed
by removing $ENV/bin/python and re-running virtualenv on the same
target directory with the upgraded Python.&lt;/em&gt;&lt;/blockquote&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="big-projects-have-a-lot-of-dependencies"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id4"&gt;Big projects have a lot of dependencies&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;At Paylogic we create large virtual environments with &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt;: At the time of
writing our main code base has 84 dependencies if we include testing,
documentation and transitive dependencies (43 of those dependencies are required
in production). Some of these dependencies require SWIG and a compiler and for
large modules the compilation can take a while.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pip-can-be-slow-and-unreliable"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id5"&gt;pip can be slow and unreliable&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;So we build a lot of virtual environments, which can be really slow. The actual
creation of the environment only takes a couple of seconds, but installing all
of the dependencies can take minutes! For example at the time of writing it
takes about seven minutes to install all dependencies of Paylogic's main code
base using &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;What's worse is that PyPI and distribution websites can be very unreliable.
One day everything works fine, the next day the same packages you downloaded
previously can no longer be downloaded. Usually these are transient errors, you
just have to be very patient and/or retry until it works.&lt;/p&gt;
&lt;p&gt;We love virtual environments and pip so we don't necessarily need to replace
either of those, but it would be nice to solve these two problems.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="optimizing-pip"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;Optimizing pip&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;In this section we'll discuss ways in which we can speed up pip.&lt;/p&gt;
&lt;div class="section" id="brute-force-caching"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id7"&gt;Brute force caching&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;If no requirements changed, we can re-use a previously built and cached virtual
environment. &lt;a class="reference external" href="https://pypi.python.org/pypi/terrarium"&gt;Terrarium&lt;/a&gt; takes this approach. There is a drawback however: If a
single dependency changes, we can't re-use the cache and have to rebuild
everything. This is not exactly ideal for continuous integration/deployment
environments (which is a big use case for us).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="so-what-about-a-more-granular-approach"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id8"&gt;So what about a more granular approach?&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;There are two obvious targets:&lt;/p&gt;
&lt;ol class="arabic"&gt;
&lt;li&gt;&lt;p class="first"&gt;Given absolute version numbers available in the download cache, &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt; still
goes out and scans PyPI and distribution websites. This is documented
behavior:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;pip offers a &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--download-cache&lt;/span&gt;&lt;/tt&gt; option for installs to prevent redundant
downloads of archives from PyPI. The point of this cache is not to
circumvent the index crawling process, but to just prevent redundant
downloads. Items are stored in this cache based on the url the archive
was found at, not simply the archive name. If you want a fast/local
install solution that circumvents crawling PyPI, see the &lt;a class="reference external" href="http://www.pip-installer.org/en/latest/cookbook.html#fast-local-installs"&gt;Fast &amp;amp; Local
Installs&lt;/a&gt; Cookbook entry.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Binary packages are recompiled for every virtual environment. This is
because historically &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt; did not support binary distributions (support for
the &lt;a class="reference external" href="http://wheel.readthedocs.org/en/latest/"&gt;Wheel&lt;/a&gt; format is now coming) so the only option was to go for source
packages, which require compilation. However there is of course no reason
why previous results can not be reused.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="section" id="keeping-pip-off-the-internet"&gt;
&lt;h4&gt;Keeping pip off the internet&lt;/h4&gt;
&lt;p&gt;Our first problem was that pip's index crawling process is very slow, so we
want to avoid it when possible. So how can we keep &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt; from always scanning
PyPI and distribution websites when all of the dependencies are already
available in the local download cache? Here's how:&lt;/p&gt;
&lt;ol class="arabic"&gt;
&lt;li&gt;&lt;p class="first"&gt;We generate a local source package index based on the &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt; download cache.
This local source package index is just a directory with source packages
downloaded from PyPI and distribution websites.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;We then run &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt; as follows:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;pip install --no-index --find-links&lt;span class="o"&gt;=&lt;/span&gt;file://&lt;span class="nv"&gt;$LOCAL_INDEX&lt;/span&gt; --requirement&lt;span class="o"&gt;=&lt;/span&gt;example.txt
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If the command succeeds it means all of the requirements (including the
transitive dependencies) can be satisfied from the local index. In this case
we don't need a network connection!&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class="section" id="caching-compiled-packages"&gt;
&lt;h4&gt;Caching compiled packages&lt;/h4&gt;
&lt;p&gt;Our second problem was that &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt; always recompiles binary modules. This isn't
very hard to fix. Here's how you create a dumb binary distribution (a tar
archive with binary artifacts specific to your current system):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;python setup.py bdist_dumb --format&lt;span class="o"&gt;=&lt;/span&gt;gztar
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Unfortunately these distributions are really dumb:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;tar tf ipython-0.13.2.linux-x86_64.tar.gz &lt;span class="p"&gt;|&lt;/span&gt; tail -n1
./home/peter/.virtualenvs/pip-accel/lib/python2.6/site-packages/IPython/lib/security.py
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Dumb binary distributions contain hard coded pathnames specific to the virtual
environment we created them for! This is useless in any other context. Of
course with a bit of work these pathnames can be normalized to the root of the
(virtual) environment...&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="putting-it-all-together-pip-accel"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;Putting it all together: pip-accel&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;So now you know why and how &lt;a class="reference external" href="https://github.com/paylogic/pip-accel"&gt;pip-accel&lt;/a&gt; was born! It's available on &lt;a class="reference external" href="https://pypi.python.org/pypi/pip-accel"&gt;PyPI&lt;/a&gt; and
&lt;a class="reference external" href="https://github.com/paylogic/pip-accel"&gt;GitHub&lt;/a&gt; but if you just want to try it out you can use the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;pip install pip-accel
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The command &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;pip-accel&lt;/span&gt;&lt;/tt&gt; will be installed in your environment. You should be
able to use it just like &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt;, simply type &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;pip-accel&lt;/span&gt;&lt;/tt&gt; where you would
previously type &lt;tt class="docutils literal"&gt;pip&lt;/tt&gt; on the command line (you can even alias it if you
like).&lt;/p&gt;
&lt;div class="section" id="how-fast-is-it"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id10"&gt;How fast is it?&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;To give you an idea of how effective &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;pip-accel&lt;/span&gt;&lt;/tt&gt; is, below are the results of
a test to build a virtual environment for our main code base:&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="13%"&gt;&lt;/col&gt;
&lt;col width="48%"&gt;&lt;/col&gt;
&lt;col width="16%"&gt;&lt;/col&gt;
&lt;col width="22%"&gt;&lt;/col&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;Program&lt;/th&gt;
&lt;th class="head"&gt;Description&lt;/th&gt;
&lt;th class="head"&gt;Duration&lt;/th&gt;
&lt;th class="head"&gt;Percentage&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;pip&lt;/td&gt;
&lt;td&gt;Default configuration&lt;/td&gt;
&lt;td&gt;444 seconds&lt;/td&gt;
&lt;td&gt;100% (baseline)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;pip&lt;/td&gt;
&lt;td&gt;With download cache (first run)&lt;/td&gt;
&lt;td&gt;416 seconds&lt;/td&gt;
&lt;td&gt;94%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;pip&lt;/td&gt;
&lt;td&gt;With download cache (second run)&lt;/td&gt;
&lt;td&gt;318 seconds&lt;/td&gt;
&lt;td&gt;72%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;pip-accel&lt;/td&gt;
&lt;td&gt;First run&lt;/td&gt;
&lt;td&gt;397 seconds&lt;/td&gt;
&lt;td&gt;89%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;pip-accel&lt;/td&gt;
&lt;td&gt;Second run&lt;/td&gt;
&lt;td&gt;30 seconds&lt;/td&gt;
&lt;td&gt;7%&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;We have some ideas on how to make this even faster :-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="more-information"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id11"&gt;More information&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;If you're interested in more details about &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;pip-accel&lt;/span&gt;&lt;/tt&gt;, the readme on GitHub
contains more information about the &lt;a class="reference external" href="https://github.com/paylogic/pip-accel#control-flow-of-pip-accel"&gt;internal control flow&lt;/a&gt;. You're also free
to browse the &lt;a class="reference external" href="https://github.com/paylogic/pip-accel/blob/master/pip_accel/__init__.py"&gt;source code&lt;/a&gt;; it's only a few hundred lines of well documented
Python code.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="related-projects"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id12"&gt;Related projects&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;There are a lot of projects that try to improve the Python deployment process
and it is definitely worth looking around to evaluate your options:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://pypi.python.org/pypi/terrarium"&gt;Terrarium&lt;/a&gt; generates and caches complete virtual environments, accomplishing
some of the same goals as &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;pip-accel&lt;/span&gt;&lt;/tt&gt; but at a different granularity level&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.buildout.org/"&gt;Buildout&lt;/a&gt; is about reliable and repeatable deployments just like
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;pip-accel&lt;/span&gt;&lt;/tt&gt; but it tackles non-Python applications as well, in effect
reproducing complete deployment environments&lt;/li&gt;
&lt;li&gt;The &lt;a class="reference external" href="http://doc.devpi.net/"&gt;devpi project&lt;/a&gt; implements the server and client side of a Python
cheese shop (package index) with lots of additional features to support
Python package release, testing and installation activities&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- External references: --&gt;
&lt;/div&gt;
</summary><category term="python"></category><category term="deployment"></category><category term="virtual environments"></category><category term="automation"></category><category term="pip"></category><category term="open source"></category><category term="packaging"></category></entry></feed>